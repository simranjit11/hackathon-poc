# Story 2.1: Payment Request Processing

**Status:** Draft

---

## Story

**As a** banking customer  
**I want to** initiate payments and transfers via voice commands  
**So that** I can complete transactions hands-free

---

## Acceptance Criteria

1. User can request payment/transfer via voice
2. **System resolves beneficiary nicknames (e.g., "Mom") to saved payment addresses**
3. LLM extracts payment parameters (amount, payee, from_account, to_account)
4. Orchestrator calls MCP payment tool with JWT + risk attributes
5. MCP payment tool validates request and determines if elicitation is required
6. Payment request includes risk assessment (amount, payee risk, transaction type)
7. All payment data is masked before logging
8. Tool execution is sandboxed to pre-registered endpoints only

---

## Tasks / Subtasks

- [ ] **Task 0: Beneficiary Resolution (Pre-req)**
  - [ ] Ensure Story 2.0 is complete
  - [ ] Update LLM system prompt to understand beneficiary context
  - [ ] Implement `get_beneficiaries` tool call in flow

- [ ] Task 1: Payment Intent Extraction (AC: 1, 2, 3)
  - [ ] Enhance LLM prompt to extract payment parameters
  - [ ] Define payment tool schema for LLM
  - [ ] Parse LLM tool call for payment parameters
  - [ ] Validate extracted parameters
  - [ ] Handle ambiguous or incomplete requests

- [ ] Task 2: MCP Payment Tool Endpoint (AC: 4, 5, 6)
  - [ ] Create `/mcp/payment` endpoint
  - [ ] Validate JWT with transact scope
  - [ ] Extract payment parameters from request
  - [ ] Perform risk assessment (amount thresholds, payee risk)
  - [ ] Determine if elicitation is required based on policy
  - [ ] Return payment initiation response or elicitation requirement

- [ ] Task 3: Risk Assessment Logic (AC: 6)
  - [ ] Implement amount threshold checks
  - [ ] Implement payee risk scoring
  - [ ] Determine MFA requirements based on risk
  - [ ] Log risk assessment decisions

- [ ] Task 4: Data Masking and Logging (AC: 7)
  - [ ] Mask payment data before logging
  - [ ] Log masked payment requests
  - [ ] Ensure raw data never logged

- [ ] Task 5: Tool Sandboxing (AC: 8)
  - [ ] Validate tool endpoints are pre-registered
  - [ ] Block unauthorized endpoint calls
  - [ ] Log security violations

---

## Dev Notes

### Previous Story Insights
- LLM integration is working (Story 1.4)
- MCP client exists (Story 1.5)
- JWT generation is implemented (Story 1.1)
- **Beneficiaries are managed in Story 2.0**

### Architecture References
[Source: docs/architecture.md#journey-flows]

**Payment Flow:**
1. User requests transfer/payment ("Pay Bob")
2. **LLM calls `get_transfer_contacts` to resolve "Bob"**
3. **LLM extracts resolved parameters (bob@upi)**
4. Orchestrator â†’ MCP: Initiate payment request with JWT + risk attrs
5. MCP determines if elicitation needed
6. Returns `create_elicitation` if required

### Existing Codebase Context

**Files to Create:**
- `mcp-server/tools/payment.py` - Payment tool endpoint
- `mcp-server/risk_assessment.py` - Risk assessment logic

**Files to Modify:**
- `livekit-voice-agent/mcp_client.py` - Add payment tool call
- `livekit-voice-agent/llm_handler.py` - Enhance payment intent extraction

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-20 | 1.1 | Added Beneficiary Resolution dependency | John (PM) |
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
