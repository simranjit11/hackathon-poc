# Story 2.1: Payment Request Processing

**Status:** Draft

---

## Story

**As a** banking customer  
**I want to** initiate payments and transfers via voice commands  
**So that** I can complete transactions hands-free

---

## Acceptance Criteria

1. User can request payment/transfer via voice
2. LLM extracts payment parameters (amount, payee, from_account, to_account)
3. Orchestrator calls MCP payment tool with JWT + risk attributes
4. MCP payment tool validates request and determines if elicitation is required
5. Payment request includes risk assessment (amount, payee risk, transaction type)
6. All payment data is masked before logging
7. Tool execution is sandboxed to pre-registered endpoints only

---

## Tasks / Subtasks

- [ ] Task 1: Payment Intent Extraction (AC: 1, 2)
  - [ ] Enhance LLM prompt to extract payment parameters
  - [ ] Define payment tool schema for LLM
  - [ ] Parse LLM tool call for payment parameters
  - [ ] Validate extracted parameters
  - [ ] Handle ambiguous or incomplete requests

- [ ] Task 2: MCP Payment Tool Endpoint (AC: 3, 4, 5)
  - [ ] Create `/mcp/payment` endpoint
  - [ ] Validate JWT with transact scope
  - [ ] Extract payment parameters from request
  - [ ] Perform risk assessment (amount thresholds, payee risk)
  - [ ] Determine if elicitation is required based on policy
  - [ ] Return payment initiation response or elicitation requirement

- [ ] Task 3: Risk Assessment Logic (AC: 5)
  - [ ] Implement amount threshold checks
  - [ ] Implement payee risk scoring
  - [ ] Determine MFA requirements based on risk
  - [ ] Log risk assessment decisions

- [ ] Task 4: Data Masking and Logging (AC: 6)
  - [ ] Mask payment data before logging
  - [ ] Log masked payment requests
  - [ ] Ensure raw data never logged

- [ ] Task 5: Tool Sandboxing (AC: 7)
  - [ ] Validate tool endpoints are pre-registered
  - [ ] Block unauthorized endpoint calls
  - [ ] Log security violations

---

## Dev Notes

### Previous Story Insights
- LLM integration is working (Story 1.4)
- MCP client exists (Story 1.5)
- JWT generation is implemented (Story 1.1)

### Architecture References
[Source: docs/architecture.md#journey-flows]

**Payment Flow:**
1. User requests transfer/payment
2. LLM extracts parameters
3. Orchestrator â†’ MCP: Initiate payment request with JWT + risk attrs
4. MCP determines if elicitation needed
5. Returns `create_elicitation` if required

**Risk Assessment:**
- Amount thresholds
- Payee risk scoring
- Transaction type
- User history

### Existing Codebase Context

**Current Implementation:**
- `livekit-voice-agent/agent.py` has `make_payment` function tool
- Uses mock data, no real MCP integration
- No risk assessment or elicitation

**Files to Create:**
- `mcp-server/tools/payment.py` - Payment tool endpoint
- `mcp-server/risk_assessment.py` - Risk assessment logic

**Files to Modify:**
- `livekit-voice-agent/mcp_client.py` - Add payment tool call
- `livekit-voice-agent/llm_handler.py` - Enhance payment intent extraction

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

