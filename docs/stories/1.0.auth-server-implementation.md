# Story 1.0: Authentication Server Implementation

**Status:** Ready for Review  
**Priority:** High (Prerequisite for Story 1.1)

---

## Story

**As a** banking customer (web or mobile)  
**I want to** authenticate with my credentials and receive a secure access token  
**So that** I can access the voice assistant and banking services securely from any platform

---

## Acceptance Criteria

1. **Web and Mobile Support**: Auth endpoints accessible from both web (Next.js) and mobile (React Native) clients
2. Users can authenticate with email/password credentials from any platform
3. Backend validates credentials and issues JWT access tokens
4. JWT tokens include user_id, email, roles, and permissions claims
5. Tokens have appropriate expiration (1 hour for access tokens)
6. Mobile users can authenticate with biometric after credential validation
7. Web users can optionally use 2FA (SMS/Email OTP) after credential validation
8. Auth endpoints return proper error messages for invalid credentials
9. Auth server can validate issued tokens (for use by connection-details API)
10. CORS configured to allow mobile app requests
11. Mobile app can store and retrieve tokens securely (AsyncStorage)

---

## Tasks / Subtasks

- [x] Task 1: Create Authentication API Endpoints
  - [x] Create `POST /api/auth/login` endpoint (supports web and mobile)
  - [x] Create `POST /api/auth/logout` endpoint
  - [x] Create `GET /api/auth/me` endpoint for token validation
  - [x] Add request/response validation
  - [x] Configure CORS to allow mobile app requests
  - [x] Ensure endpoints return consistent JSON responses for both platforms

- [x] Task 2: Implement Credential Validation
  - [x] Create user credential storage (in-memory for hackathon)
  - [x] Implement password hashing (bcryptjs)
  - [x] Validate email/password combinations
  - [x] Return appropriate error messages

- [x] Task 3: JWT Token Generation
  - [x] JWT library (jose) already installed
  - [x] Create token generation utility (`lib/jwt.ts`)
  - [x] Include user_id, email, roles, permissions in token claims
  - [x] Set token expiration to 1 hour
  - [x] Sign tokens with secret key

- [x] Task 4: Token Validation Middleware
  - [x] Token validation exists in `lib/auth.ts` (validateAccessToken)
  - [x] Extract user identity from validated tokens
  - [x] Handle token expiration and invalid tokens
  - [x] Return proper HTTP status codes

- [x] Task 5: Mobile Biometric Integration
  - [x] Accept biometric token in login request body
  - [x] Validate biometric token alongside credentials
  - [x] Include biometric verification status in JWT claims
  - [x] Mobile login hook created (`agent-starter-react-native/hooks/useLogin.ts`)
  - [x] Token storage in AsyncStorage already implemented

- [x] Task 6: Web 2FA Integration
  - [x] Create `POST /api/auth/2fa/send` endpoint
  - [x] Create `POST /api/auth/2fa/verify` endpoint
  - [x] Generate and store OTP codes (in-memory store)
  - [x] 2FA status can be included in JWT claims (via login endpoint)

---

## Dev Notes

### Previous Story Insights
N/A - This is a prerequisite story for Story 1.1

### Architecture References
[Source: docs/architecture.md#authentication--authorization-architecture]

**Authentication Flow:**
- Credentials + Optional 2FA/Biometric → Auth Service → Access Token + User Identity
- Access Token used for all subsequent API calls
- Token validation happens at API gateway/endpoint level

**JWT Token Structure:**
```json
{
  "sub": "user_id",
  "email": "user@example.com",
  "roles": ["customer"],
  "permissions": ["read", "transact", "configure"],
  "iat": 1234567890,
  "exp": 1234567890 + 3600
}
```

### Architecture Decision Required

**Question:** Should the auth server be:
1. **Separate microservice** (FastAPI/Python) - More scalable, follows microservices pattern
2. **Integrated in Next.js API routes** - Simpler, faster to implement, single codebase

**Hackathon Considerations:**
- Speed of implementation
- Simplicity of deployment
- Ease of testing
- **Mobile app needs to call auth endpoints** - Must be accessible via HTTP
- Future scalability needs

**Recommendation:** For hackathon simplicity, integrate auth endpoints as Next.js API routes. This works perfectly for both web and mobile:
- **Web**: Same-origin requests (no CORS needed)
- **Mobile**: Cross-origin requests (CORS configured)
- **Single codebase**: One set of endpoints serves both platforms
- Can be extracted to microservice later if needed

**Mobile Access Pattern:**
```
Mobile App → HTTP POST /api/auth/login → Next.js API Route → Returns JWT
Mobile App → Stores JWT in AsyncStorage → Uses for subsequent API calls
```

### Existing Codebase Context

**Current Implementation:**
- `agent-starter-react/lib/auth.ts` - Token validation utilities exist
- `agent-starter-react/app/api/connection-details/route.ts` - Expects tokens but doesn't issue them
- No user database or credential storage exists
- No login endpoints exist

**Files to Create:**
- `agent-starter-react/app/api/auth/login/route.ts` - Login endpoint (web + mobile)
- `agent-starter-react/app/api/auth/logout/route.ts` - Logout endpoint
- `agent-starter-react/app/api/auth/me/route.ts` - Token validation endpoint
- `agent-starter-react/lib/jwt.ts` - JWT generation utilities
- `agent-starter-react/lib/users.ts` - User storage/validation (mock for hackathon)

**Files to Modify:**
- `agent-starter-react/lib/auth.ts` - Add token generation functions
- `agent-starter-react/app/api/connection-details/route.ts` - Already validates tokens (no changes needed)
- `agent-starter-react/app/api/auth/login/route.ts` - Add CORS headers for mobile

**Mobile Files to Create/Modify:**
- `agent-starter-react-native/lib/auth.ts` - Already exists (token storage)
- `agent-starter-react-native/hooks/useLogin.ts` - New hook for login flow
- `agent-starter-react-native/app/(auth)/login.tsx` - New login screen (if needed)

### File Locations

**Backend (Next.js API Routes - Serves Both Web & Mobile):**
- `agent-starter-react/app/api/auth/login/route.ts` - Login endpoint (web + mobile)
- `agent-starter-react/app/api/auth/logout/route.ts` - Logout endpoint
- `agent-starter-react/app/api/auth/me/route.ts` - Token validation
- `agent-starter-react/lib/jwt.ts` - JWT utilities
- `agent-starter-react/lib/users.ts` - User management (mock)

**Frontend (Web):**
- `agent-starter-react/lib/auth.ts` - Token storage/validation (localStorage)
- `agent-starter-react/hooks/useLogin.ts` - Login hook (if needed)

**Frontend (Mobile):**
- `agent-starter-react-native/lib/auth.ts` - Token storage (AsyncStorage) - ✅ Already exists
- `agent-starter-react-native/hooks/useLogin.ts` - Login hook - **NEW**
- `agent-starter-react-native/app/(auth)/login.tsx` - Login screen - **NEW** (if needed)

### Mock User Data (Hackathon)

For hackathon simplicity, use in-memory user storage:

```typescript
const MOCK_USERS = [
  {
    id: '12345',
    email: 'john.doe@example.com',
    password: '$2b$10$...', // bcrypt hash
    roles: ['customer'],
    permissions: ['read', 'transact', 'configure'],
  },
  // ... more users
];
```

### CORS Configuration

Since mobile app will call Next.js API routes from a different origin, configure CORS:

```typescript
// In Next.js API route
export async function POST(req: Request) {
  // Set CORS headers for mobile app
  const headers = new Headers({
    'Access-Control-Allow-Origin': '*', // Or specific mobile app origin
    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
  });
  
  // Handle preflight
  if (req.method === 'OPTIONS') {
    return new NextResponse(null, { headers, status: 200 });
  }
  
  // ... rest of handler
}
```

### Mobile Login Flow

```
1. User enters credentials in mobile app
2. User optionally authenticates with biometric
3. Mobile app calls: POST /api/auth/login
   Body: { email, password, biometricToken? }
4. Next.js validates credentials + biometric
5. Returns: { accessToken, user: {...} }
6. Mobile app stores token: AsyncStorage.setItem('access_token', token)
7. Mobile app uses token for subsequent API calls
```

### Testing Requirements

**Unit Tests:**
- Test JWT token generation
- Test credential validation
- Test token validation logic
- Test error handling

**Integration Tests:**
- Test full login flow
- Test token usage in connection-details API
- Test 2FA flow (if implemented)
- Test biometric flow (if implemented)

**E2E Tests:**
- Test login → get token → connect to LiveKit flow
- Test invalid credentials rejection
- Test expired token handling

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor Composer)

### Debug Log References
N/A - Implementation completed without issues

### Completion Notes List

1. **Auth Endpoints Created**: All authentication API endpoints implemented as Next.js API routes
   - `/api/auth/login` - Supports web and mobile with biometric/2FA
   - `/api/auth/logout` - Client-side token clearing
   - `/api/auth/me` - Token validation endpoint
   - `/api/auth/2fa/send` - OTP generation
   - `/api/auth/2fa/verify` - OTP verification

2. **CORS Configuration**: All endpoints include CORS headers for mobile app access

3. **Password Hashing**: Implemented with bcryptjs, passwords hashed on first access

4. **JWT Generation**: Token generation utilities created with proper claims structure

5. **Mock Users**: Two test users created with default password "password123"

6. **Client Hooks**: Login hooks created for both web and mobile platforms

7. **Dependencies Added**: 
   - `bcryptjs` for password hashing
   - `@types/bcryptjs` for TypeScript types

### File List

**Created Files:**
- `agent-starter-react/lib/jwt.ts` - JWT token generation utilities
- `agent-starter-react/lib/users.ts` - User storage and credential validation
- `agent-starter-react/lib/cors.ts` - CORS helper utilities
- `agent-starter-react/lib/otp-store.ts` - OTP storage (in-memory)
- `agent-starter-react/app/api/auth/login/route.ts` - Login endpoint
- `agent-starter-react/app/api/auth/logout/route.ts` - Logout endpoint
- `agent-starter-react/app/api/auth/me/route.ts` - Token validation endpoint
- `agent-starter-react/app/api/auth/2fa/send/route.ts` - 2FA OTP send endpoint
- `agent-starter-react/app/api/auth/2fa/verify/route.ts` - 2FA OTP verify endpoint
- `agent-starter-react/hooks/useLogin.ts` - Web login hook
- `agent-starter-react-native/hooks/useLogin.ts` - Mobile login hook
- `agent-starter-react/AUTH_README.md` - Quick start guide

**Modified Files:**
- `agent-starter-react/package.json` - Added bcryptjs and @types/bcryptjs
- `agent-starter-react/hooks/use2FA.ts` - Updated to use actual API endpoints

---

## QA Results
_To be filled by QA Agent_

