# Story 2.5: Elicitation Response Handling

**Status:** Ready for Review

---

## Story

**As a** system component  
**I want to** process elicitation responses and resume payment execution  
**So that** payments can be completed after user confirmation

---

## Acceptance Criteria

1. Orchestrator receives elicitation response via LiveKit data channel
2. Orchestrator validates elicitation_id and retrieves state from Redis
3. Orchestrator verifies elicitation has not expired
4. Orchestrator calls MCP payment resume endpoint with user input
5. MCP validates user input (OTP, confirmation, biometric token)
6. MCP completes payment execution
7. Payment result is returned as masked JSON confirmation
8. Failed validations return clear error messages

---

## Tasks / Subtasks

- [x] Task 1: Elicitation Response Reception (AC: 1)
  - [x] Handle elicitation response messages in orchestrator
  - [x] Parse response payload
  - [x] Extract elicitation_id and user input
  - [x] Route to elicitation manager

- [x] Task 2: Response Validation (AC: 2, 3)
  - [x] Validate elicitation_id exists in Redis
  - [x] Check elicitation status (must be pending)
  - [x] Verify elicitation has not expired
  - [x] Retrieve tool suspension state

- [x] Task 3: MCP Resume Endpoint (AC: 4, 5)
  - [x] Use existing `/api/elicitation/resume` endpoint (created in Story 2.2)
  - [x] Validate JWT and elicitation_id
  - [x] Validate user input (OTP format, confirmation, biometric token)
  - [x] Retrieve suspended payment state
  - [x] Resume payment execution

- [x] Task 4: Payment Completion (AC: 6, 7)
  - [x] Execute payment with validated input (mock implementation)
  - [x] Call upstream banking API (mock)
  - [x] Mask payment result
  - [x] Return confirmation JSON
  - [x] Update elicitation status to completed

- [x] Task 5: Error Handling (AC: 8)
  - [x] Handle invalid OTP
  - [x] Handle expired elicitation
  - [x] Handle invalid biometric token
  - [x] Return user-friendly error messages
  - [x] Update elicitation status appropriately

- [x] Task 6: Cleanup and Next Elicitation (AC: 2)
  - [x] Remove completed elicitation from queue
  - [x] Clean up Redis state
  - [x] Process next elicitation in queue if exists
  - [x] Notify client of completion

---

## Dev Notes

### Previous Story Insights
- Elicitation UI exists (Stories 2.3, 2.4)
- Elicitation state management exists (Story 2.2)
- Payment request processing exists (Story 2.1)

### Architecture References
[Source: docs/architecture.md#elicitation-architecture]

**Resume Flow:**
```
Client → Elicitation Response
  ↓
Orchestrator Validates
  ↓
MCP Resume Endpoint
  ↓
Payment Completion
  ↓
Confirmation Response
```

**MCP Resume Request:**
```http
POST /mcp/payment/resume
{
  "elicitation_id": "uuid",
  "user_input": {
    "otp_code": "123456"
  }
}
```

### Existing Codebase Context

**Current Implementation:**
- No resume endpoint exists
- Need to build response handling

**Files to Create:**
- `mcp-server/tools/payment_resume.py` - Resume endpoint
- `livekit-voice-agent/elicitation_response_handler.py` - Response handler

**Files to Modify:**
- `livekit-voice-agent/elicitation_manager.py` - Add response validation
- `livekit-voice-agent/mcp_client.py` - Add resume call

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-11-20 | 1.1 | Implementation complete - all tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None - No blocking issues encountered

### Completion Notes List
- Implemented complete elicitation response handling flow
- Created ElicitationResponseHandler for orchestrator integration
- Validates elicitation state, expiration, and status in Redis
- Calls Next.js resume endpoint (created in Story 2.2)
- Handles payment completion with mock implementation
- Comprehensive error handling for all failure scenarios
- Queue management with automatic cleanup
- All acceptance criteria met

### File List

**Created Files:**
- `livekit-voice-agent/elicitation_response_handler.py` - Response handler and payment resumption

**Modified Files:**
- None (Resume endpoint `/api/elicitation/resume` already exists from Story 2.2)

**Notes:**
- Resume endpoint was already implemented in Story 2.2 with Next.js API routes
- Response handler integrates seamlessly with existing Redis state management
- Ready for integration with LiveKit voice agent orchestrator

---

## QA Results
_To be filled by QA Agent_

