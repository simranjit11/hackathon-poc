# Story 2.5: Elicitation Response Handling

**Status:** Draft

---

## Story

**As a** system component  
**I want to** process elicitation responses and resume payment execution  
**So that** payments can be completed after user confirmation

---

## Acceptance Criteria

1. Orchestrator receives elicitation response via LiveKit data channel
2. Orchestrator validates elicitation_id and retrieves state from Redis
3. Orchestrator verifies elicitation has not expired
4. Orchestrator calls MCP payment resume endpoint with user input
5. MCP validates user input (OTP, confirmation, biometric token)
6. MCP completes payment execution
7. Payment result is returned as masked JSON confirmation
8. Failed validations return clear error messages

---

## Tasks / Subtasks

- [ ] Task 1: Elicitation Response Reception (AC: 1)
  - [ ] Handle elicitation response messages in orchestrator
  - [ ] Parse response payload
  - [ ] Extract elicitation_id and user input
  - [ ] Route to elicitation manager

- [ ] Task 2: Response Validation (AC: 2, 3)
  - [ ] Validate elicitation_id exists in Redis
  - [ ] Check elicitation status (must be pending)
  - [ ] Verify elicitation has not expired
  - [ ] Retrieve tool suspension state

- [ ] Task 3: MCP Resume Endpoint (AC: 4, 5)
  - [ ] Create `/mcp/payment/resume` endpoint
  - [ ] Validate JWT and elicitation_id
  - [ ] Validate user input (OTP format, confirmation, biometric token)
  - [ ] Retrieve suspended payment state
  - [ ] Resume payment execution

- [ ] Task 4: Payment Completion (AC: 6, 7)
  - [ ] Execute payment with validated input
  - [ ] Call upstream banking API
  - [ ] Mask payment result
  - [ ] Return confirmation JSON
  - [ ] Update elicitation status to completed

- [ ] Task 5: Error Handling (AC: 8)
  - [ ] Handle invalid OTP
  - [ ] Handle expired elicitation
  - [ ] Handle invalid biometric token
  - [ ] Return user-friendly error messages
  - [ ] Update elicitation status appropriately

- [ ] Task 6: Cleanup and Next Elicitation (AC: 2)
  - [ ] Remove completed elicitation from queue
  - [ ] Clean up Redis state
  - [ ] Process next elicitation in queue if exists
  - [ ] Notify client of completion

---

## Dev Notes

### Previous Story Insights
- Elicitation UI exists (Stories 2.3, 2.4)
- Elicitation state management exists (Story 2.2)
- Payment request processing exists (Story 2.1)

### Architecture References
[Source: docs/architecture.md#elicitation-architecture]

**Resume Flow:**
```
Client → Elicitation Response
  ↓
Orchestrator Validates
  ↓
MCP Resume Endpoint
  ↓
Payment Completion
  ↓
Confirmation Response
```

**MCP Resume Request:**
```http
POST /mcp/payment/resume
{
  "elicitation_id": "uuid",
  "user_input": {
    "otp_code": "123456"
  }
}
```

### Existing Codebase Context

**Current Implementation:**
- No resume endpoint exists
- Need to build response handling

**Files to Create:**
- `mcp-server/tools/payment_resume.py` - Resume endpoint
- `livekit-voice-agent/elicitation_response_handler.py` - Response handler

**Files to Modify:**
- `livekit-voice-agent/elicitation_manager.py` - Add response validation
- `livekit-voice-agent/mcp_client.py` - Add resume call

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

