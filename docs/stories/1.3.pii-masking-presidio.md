# Story 1.3: PII Masking with Presidio

**Status:** Draft

---

## Story

**As a** compliance system  
**I want to** mask personally identifiable information before processing  
**So that** sensitive data is protected throughout the conversation flow

---

## Acceptance Criteria

1. Presidio runs inline within Orchestrator process before LLM calls
2. PII entities (account numbers, SSNs, phone numbers, etc.) are detected and masked
3. Masked transcript replaces original transcript in all downstream processing
4. Original transcript is NOT logged or persisted (only masked version)
5. Masking latency is optimized to meet real-time conversation requirements (<100ms)
6. Masked entities are replaced with consistent placeholders (e.g., `[ACCOUNT_NUMBER]`)
7. Masking format follows standards: Account numbers `****1234`, SSNs `***-**-1234`, Phone `(***) ***-1234`

---

## Tasks / Subtasks

- [ ] Task 1: Integrate Presidio into Orchestrator (AC: 1)
  - [ ] Install Presidio analyzer and anonymizer packages
  - [ ] Create `presidio_masker.py` module
  - [ ] Initialize Presidio analyzer with banking-specific entities
  - [ ] Configure Presidio to run inline in orchestrator process
  - [ ] Optimize Presidio configuration for low latency

- [ ] Task 2: Implement PII Detection and Masking (AC: 2, 6, 7)
  - [ ] Configure Presidio to detect: account numbers, SSNs, phone numbers, emails, credit cards, routing numbers
  - [ ] Implement masking with consistent placeholders
  - [ ] Apply masking format standards (account: `****1234`, SSN: `***-**-1234`, phone: `(***) ***-1234`)
  - [ ] Handle edge cases and partial matches

- [ ] Task 3: Integrate Masking into Transcript Flow (AC: 3, 4)
  - [ ] Mask transcripts before storing in Redis
  - [ ] Mask transcripts before sending to LLM
  - [ ] Ensure original transcripts are never persisted
  - [ ] Update transcript manager to use masked versions only

- [ ] Task 4: Performance Optimization (AC: 5)
  - [ ] Profile Presidio masking latency
  - [ ] Optimize Presidio configuration for speed
  - [ ] Implement caching for common patterns
  - [ ] Ensure masking completes in <100ms
  - [ ] Add metrics for masking latency

- [ ] Task 5: Testing and Validation (AC: 2, 6, 7)
  - [ ] Create test cases with various PII formats
  - [ ] Validate masking accuracy
  - [ ] Test masking performance
  - [ ] Verify no original transcripts are persisted

---

## Dev Notes

### Previous Story Insights
- Transcripts are already being stored in Redis (Story 1.2)
- Need to intercept transcripts before storage and LLM calls

### Architecture References
[Source: docs/architecture.md#security-architecture]

**PII Masking Strategy:**
- Presidio runs inline within Orchestrator process
- Masks PII before LLM calls
- Masks PII before logging
- Masks PII before client transmission

**Masked Entities:**
- Account numbers
- Social Security Numbers
- Phone numbers
- Email addresses
- Credit card numbers
- Bank routing numbers

**Masking Format:**
- Account numbers: `****1234`
- SSNs: `***-**-1234`
- Phone: `(***) ***-1234`

**Performance Requirements:**
- Masking latency: <100ms
- Real-time conversation requirements

### Existing Codebase Context

**Current Implementation:**
- No PII masking currently implemented
- Transcripts flow directly from STT to LLM
- Need to add masking layer between STT and LLM

**Files to Modify:**
- `livekit-voice-agent/transcript_manager.py` - Add masking before storage
- `livekit-voice-agent/llm_handler.py` - Add masking before LLM calls

**Files to Create:**
- `livekit-voice-agent/presidio_masker.py` - Presidio integration module
- `livekit-voice-agent/config/presidio_config.py` - Presidio configuration

### File Locations

**Backend (Orchestrator):**
- `livekit-voice-agent/presidio_masker.py` - New file for Presidio integration
- `livekit-voice-agent/config/presidio_config.py` - New file for Presidio configuration
- `livekit-voice-agent/transcript_manager.py` - Modify to add masking
- `livekit-voice-agent/llm_handler.py` - Modify to add masking

### Dependencies

**Python Packages:**
- `presidio-analyzer` - For PII detection
- `presidio-anonymizer` - For PII masking
- `spacy` - NLP backend for Presidio (optional, can use default)

### Testing Requirements

**Unit Tests:**
- Test PII detection for each entity type
- Test masking format correctness
- Test masking performance (<100ms)
- Test edge cases (partial matches, false positives)

**Integration Tests:**
- Test masking integration in transcript flow
- Test that original transcripts are never persisted
- Test masking before LLM calls

**Performance Tests:**
- Benchmark masking latency
- Ensure <100ms requirement is met
- Test with various transcript lengths

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

