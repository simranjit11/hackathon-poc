# Story 1.7: Natural Language Response Formatting

**Status:** Draft  
**Priority:** ðŸ”¥ **HIGH PRIORITY** (Core Voice Pipeline)

---

## Story

**As a** banking customer  
**I want to** hear my account information recited in natural, conversational language  
**So that** I can understand my banking details without reading or seeing visual cards

---

## Acceptance Criteria

1. Transaction history is formatted as natural language narration (e.g., "Sam transferred $20 to Simran, Simran transferred $20 to Sam...")
2. Transaction narration includes up to 5 transactions per response
3. After reciting transactions, LLM asks "Do you want me to tell you the next 5 transactions?"
4. Balance information is narrated in conversational format (e.g., "Your checking account has $2,547.83")
5. Loan information is narrated naturally (e.g., "You have a mortgage with a balance of $285,000 at 3.75% interest")
6. All narration uses natural, conversational language (not robotic lists)
7. Account numbers are masked in narration (e.g., "account ending in 1234")
8. Narration is concise but complete
9. User can request more transactions by responding "yes" or "tell me more"
10. Response formatter handles pagination for long transaction lists

---

## Tasks / Subtasks

- [ ] Task 1: Transaction History Formatting (AC: 1, 2, 3, 10)
  - [ ] Create transaction narration formatter
  - [ ] Format transactions as natural sentences (e.g., "Sam transferred $20 to Simran")
  - [ ] Limit to 5 transactions per narration
  - [ ] Add follow-up question: "Do you want me to tell you the next 5 transactions?"
  - [ ] Handle transaction pagination state
  - [ ] Track which transactions have been narrated

- [ ] Task 2: Balance Narration Formatting (AC: 4, 6, 7)
  - [ ] Format balance information conversationally
  - [ ] Use natural language (e.g., "Your checking account has $2,547.83")
  - [ ] Mask account numbers in narration (e.g., "account ending in 1234")
  - [ ] Include account type naturally
  - [ ] Keep narration concise

- [ ] Task 3: Loan Information Formatting (AC: 5, 6, 7)
  - [ ] Format loan details conversationally
  - [ ] Include loan type, balance, rate, payment naturally
  - [ ] Mask loan account numbers
  - [ ] Use conversational language

- [ ] Task 4: Follow-up Request Handling (AC: 9, 10)
  - [ ] Detect user requests for more transactions ("yes", "tell me more", "next 5")
  - [ ] Retrieve next 5 transactions from cache
  - [ ] Format and narrate next batch
  - [ ] Continue pagination until all transactions narrated
  - [ ] Handle end of transaction list gracefully

- [ ] Task 5: Natural Language Optimization (AC: 6, 8)
  - [ ] Ensure all narration sounds natural and conversational
  - [ ] Avoid robotic list formatting
  - [ ] Use varied sentence structures
  - [ ] Keep responses concise but complete
  - [ ] Test narration quality and flow

---

## Dev Notes

### Previous Story Insights
- TTS response generation exists (Story 1.6)
- Response formatting needs to be enhanced for natural language
- MCP tools return structured JSON data (Story 1.5)

### Architecture References
[Source: docs/architecture.md#journey-flows]

**Response Formatting:**
- Natural language narration (not visual cards)
- Conversational format for all data types
- Transaction history: "Sam transferred $20 to Simran, Simran transferred $20 to Sam..."
- Pagination: "Do you want me to tell you the next 5 transactions?"

**Narration Requirements:**
- Natural, conversational language
- Concise but complete
- Masked account numbers in narration
- Pagination support for long lists

### Existing Codebase Context

**Current Implementation:**
- `livekit-voice-agent/agent.py` has basic response formatting
- Function tools return string responses
- Need to enhance formatting for natural language narration
- Need to add pagination support

**Files to Create:**
- `livekit-voice-agent/response_formatter.py` - Natural language formatter
- `livekit-voice-agent/narration_formatter.py` - Narration-specific formatting

**Files to Modify:**
- `livekit-voice-agent/agent.py` - Use enhanced formatters
- `livekit-voice-agent/transcript_manager.py` - Track pagination state

### File Locations

**Backend (Orchestrator):**
- `livekit-voice-agent/response_formatter.py` - New file for natural language formatting
- `livekit-voice-agent/narration_formatter.py` - New file for narration-specific logic
- `livekit-voice-agent/agent.py` - Modify to use formatters

### Example Narration Formats

**Transaction History:**
```
"Here are your recent transactions: Sam transferred $20 to Simran, Simran transferred $20 to Sam, you paid $87.32 at the grocery store, you received a salary deposit of $3,200, and you spent $45.67 at the gas station. Do you want me to tell you the next 5 transactions?"
```

**Balance:**
```
"Your checking account ending in 1234 has a balance of $2,547.83. Your savings account ending in 5678 has $15,430.22."
```

**Loans:**
```
"You have a mortgage with a balance of $285,000 at 3.75% interest. Your monthly payment is $1,820.50. You also have an auto loan with a balance of $18,500 at 4.25% interest, with a monthly payment of $435.20."
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-01-XX | 1.1 | Changed from visual data cards to natural language narration format. Transaction history now recited as "Sam transferred $20 to Simran..." with pagination support | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

