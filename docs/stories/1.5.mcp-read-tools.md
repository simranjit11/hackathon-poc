# Story 1.5: MCP Read Tools (Balance, Transactions, Loans)

**Status:** Draft  
**Priority:** ðŸ”¥ **HIGH PRIORITY** (Core Data Pipeline)

---

## Story

**As a** banking customer  
**I want to** retrieve my account information via voice commands  
**So that** I can check balances, view transactions, and inquire about loans

---

## Acceptance Criteria

1. MCP FastAPI server exposes read-only banking tools
2. Tools require JWT authentication with read scope
3. Balance lookup tool returns account balances for all account types
4. Transaction history tool returns recent transactions with filtering
5. Loan information tool returns loan details and payment schedules
6. All results are masked before returning to orchestrator
7. Results are cached appropriately (balances: 5min, transactions: 2min)
8. Tool execution is logged with masked payloads for audit

---

## Tasks / Subtasks

- [ ] Task 1: Create MCP FastAPI Server Structure (AC: 1)
  - [ ] Set up FastAPI project structure
  - [ ] Create base MCP server with health check endpoint
  - [ ] Set up CORS and middleware
  - [ ] Configure logging and error handling

- [ ] Task 2: JWT Authentication Middleware (AC: 2)
  - [ ] Implement JWT validation middleware
  - [ ] Validate JWT signature, expiration, and scopes
  - [ ] Extract user_id from JWT claims
  - [ ] Enforce read scope for read-only tools
  - [ ] Handle authentication errors

- [ ] Task 3: Balance Lookup Tool (AC: 3, 6, 7, 8)
  - [ ] Create `/mcp/balance` endpoint
  - [ ] Query banking API for account balances
  - [ ] Mask account numbers (show last 4 digits)
  - [ ] Return balances for all account types
  - [ ] Cache results with 5-minute TTL
  - [ ] Log request/response with masked data

- [ ] Task 4: Transaction History Tool (AC: 4, 6, 7, 8)
  - [ ] Create `/mcp/transactions` endpoint
  - [ ] Accept query parameters (account, date range, limit)
  - [ ] Query banking API for transactions
  - [ ] Mask sensitive merchant information
  - [ ] Sort by date (most recent first)
  - [ ] Cache results with 2-minute TTL
  - [ ] Log request/response with masked data

- [ ] Task 5: Loan Information Tool (AC: 5, 6, 7, 8)
  - [ ] Create `/mcp/loans` endpoint
  - [ ] Query banking API for loan information
  - [ ] Return loan type, balance, rate, payment, term
  - [ ] Mask loan account numbers
  - [ ] Cache results with 10-minute TTL
  - [ ] Log request/response with masked data

- [ ] Task 6: Orchestrator MCP Client Integration (AC: 1, 2)
  - [ ] Create `mcp_client.py` module
  - [ ] Implement JWT generation for MCP calls
  - [ ] Create HTTP client for MCP endpoints
  - [ ] Handle MCP errors and retries
  - [ ] Integrate with orchestrator tool call flow

---

## Dev Notes

### Previous Story Insights
- JWT generation is already implemented in orchestrator (Story 1.1)
- Tool call validation is handled by LLM handler (Story 1.4)

### Architecture References
[Source: docs/architecture.md#component-architecture]

**MCP FastAPI Server:**
- Exposes hardened, JWT-authenticated banking tools
- Emits elicitation pauses when user validation is required
- Endpoints: `/mcp/balance`, `/mcp/transactions`, `/mcp/loans`

**JWT Authentication:**
- Short-lived JWTs (5-15 minutes)
- Scopes: `read`, `transact`, `configure`
- MCP validates JWT before execution

**Caching Strategy:**
- Balance results: 5 minutes TTL
- Transaction results: 2 minutes TTL
- Loan results: 10 minutes TTL

**Data Masking:**
- Account numbers: `****1234`
- Sensitive merchant information masked
- All logs use masked data only

### Existing Codebase Context

**Current Implementation:**
- No MCP server exists yet
- Agent has mock data in `agent.py` with function tools
- Need to create separate MCP FastAPI server

**Files to Create:**
- `mcp-server/` - New directory for MCP server
- `mcp-server/main.py` - FastAPI application
- `mcp-server/auth.py` - JWT validation
- `mcp-server/tools/balance.py` - Balance tool
- `mcp-server/tools/transactions.py` - Transactions tool
- `mcp-server/tools/loans.py` - Loans tool

**Files to Modify:**
- `livekit-voice-agent/mcp_client.py` - Create MCP client

### File Locations

**MCP Server (New Service):**
- `mcp-server/main.py` - FastAPI application entry point
- `mcp-server/auth.py` - JWT authentication middleware
- `mcp-server/tools/balance.py` - Balance lookup tool
- `mcp-server/tools/transactions.py` - Transaction history tool
- `mcp-server/tools/loans.py` - Loan information tool
- `mcp-server/config.py` - Configuration
- `mcp-server/models.py` - Data models

**Backend (Orchestrator):**
- `livekit-voice-agent/mcp_client.py` - New file for MCP client

### Dependencies

**MCP Server:**
- `fastapi` - Web framework
- `python-jose` - JWT handling
- `httpx` - HTTP client for banking API
- `redis` - Caching (optional, can use in-memory)

### Testing Requirements

**Unit Tests:**
- Test JWT validation
- Test each tool endpoint
- Test data masking
- Test caching logic

**Integration Tests:**
- Test full flow: Orchestrator â†’ MCP â†’ Banking API
- Test authentication flow
- Test error handling

**E2E Tests:**
- Test balance inquiry end-to-end
- Test transaction history end-to-end
- Test loan inquiry end-to-end

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

