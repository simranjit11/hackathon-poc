# Story 2.0: Beneficiary Management

**Status:** Ready for Review

---

## Story

**As a** banking customer  
**I want to** manage my list of trusted beneficiaries (contacts)  
**So that** I can easily send money to "Mom" or "Bob" using voice commands without dictating account numbers

---

## Acceptance Criteria

1.  **Data Model Support**: System stores beneficiaries with `nickname`, `full_name`, `payment_address` (UPI/Account), and `bank_name`.
2.  **Unique Nicknames**: Users cannot have two beneficiaries with the same nickname (e.g., two "Bob"s).
3.  **Internal API**: The Auth Server (Next.js) exposes a secured internal API endpoint to fetch beneficiaries for a user.
4.  **MCP Integration**: The MCP Server has a tool `get_beneficiaries` that calls the internal API.
5.  **LLM Context**: The Voice Agent can retrieve this list to resolve natural language names ("Bob") to payment addresses.
6.  **Security**: Beneficiary data is fetched via server-to-server authentication using `INTERNAL_API_KEY`.
7.  **Default Contacts**: New users get default contacts (Mom, Bob, Joe) on signup.

---

## Tasks / Subtasks

- [x] **Task 1: Database Schema Update (Next.js)**
  - [x] Update `prisma/schema.prisma` with `Beneficiary` model
  - [x] Run migration to create table
  - [x] Add relation to `User` model

- [x] **Task 2: Internal API Endpoint (Next.js)**
  - [x] Create `GET /api/internal/users/[id]/beneficiaries`
  - [x] Implement API Key validation middleware
  - [x] Return sanitized list of beneficiaries

- [x] **Task 3: MCP Client Implementation (Python)**
  - [x] Update `backend_client.py` to add `get_beneficiaries(user_id)`
  - [x] Handle API errors and empty states gracefully

- [x] **Task 4: MCP Tool Creation (Python)**
  - [x] Create `get_transfer_contacts` tool in `mcp-server`
  - [x] Expose tool to LLM with clear description for resolution logic

- [x] **Task 5: Seed Data**
  - [x] Add mock beneficiaries for test users in `prisma/seed.ts` for immediate testing
  - [x] Update `createUser` in `lib/users.ts` to add default contacts for new users

---

## Dev Notes

### Architecture Alignment
- **System of Record**: Next.js Postgres database (not MCP local DB).
- **Access Pattern**: MCP acts as a client to Next.js for this data.
- **Security**: Uses the existing Server-to-Server Auth pattern (RFC 1.0).

### Technical Implementation
```prisma
model Beneficiary {
  id             String   @id @default(uuid())
  userId         String
  nickname       String   // The key for voice resolution
  paymentAddress String   // The value needed for transaction
  // ...
}
```

---

## Dev Agent Record

### Agent Model Used
claude-3-5-sonnet-20240620

### Debug Log References
- None - implementation was straightforward

### Completion Notes List
- Implemented `Beneficiary` model in Prisma schema with relation to `User`
- Created internal API endpoint `/api/internal/users/[id]/beneficiaries` secured with `INTERNAL_API_KEY`
- Updated `BackendAPIClient` in `mcp-server/backend_client.py` to fetch beneficiaries
- Added `get_transfer_contacts` tool in `mcp-server/main.py` for LLM usage
- Seeded database with mock beneficiaries for John Doe (Mom, Landlord) and Jane Smith (Sister)
- Updated `createUser` function to automatically add "Mom", "Bob", and "Joe" for any new user signup.

### File List
- `agent-starter-react/prisma/schema.prisma`
- `agent-starter-react/prisma/seed.ts`
- `agent-starter-react/app/api/internal/users/[id]/beneficiaries/route.ts`
- `agent-starter-react/lib/users.ts`
- `mcp-server/backend_client.py`
- `mcp-server/main.py`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-20 | 1.0 | Initial creation | John (PM) |
| 2025-11-20 | 1.1 | Implementation complete | James (Dev) |
| 2025-11-20 | 1.2 | Added default contacts on signup | James (Dev) |
