# Story 1.2: Audio Capture and STT Integration

**Status:** Draft  
**Priority:** ðŸ”¥ **HIGH PRIORITY** (Core Voice Pipeline)

---

## Story

**As a** banking customer  
**I want to** speak my inquiries naturally  
**So that** the voice assistant can understand and process my requests

---

## Acceptance Criteria

1. Client captures audio input from user microphone (16kHz, mono, PCM)
2. Audio stream is sent to LiveKit SFU in real-time
3. Client displays visual indicator that audio is being captured
4. Orchestrator receives audio packets from LiveKit
5. Orchestrator streams audio to STT Provider (AssemblyAI/Deepgram)
6. STT Provider returns partial transcript fragments as user speaks
7. Orchestrator aggregates transcript fragments into complete utterances
8. Transcript is stored in Redis session cache for conversation context
9. STT errors are handled gracefully with fallback to text input option

---

## Tasks / Subtasks

- [ ] Task 1: Enhance Client Audio Capture (AC: 1, 2, 3)
  - [ ] Verify audio capture settings (16kHz, mono, PCM) in `useRoom.ts`
  - [ ] Ensure microphone permissions are requested and handled gracefully
  - [ ] Add visual indicator (waveform animation) when audio is being captured
  - [ ] Update `AgentControlBar` to show microphone status
  - [ ] Handle microphone errors gracefully

- [ ] Task 2: Orchestrator Audio Handler (AC: 4)
  - [ ] Create `stt_handler.py` module
  - [ ] Implement audio packet reception from LiveKit
  - [ ] Handle audio stream events from LiveKit room
  - [ ] Buffer audio packets for STT streaming

- [ ] Task 3: STT Provider Integration (AC: 5, 6)
  - [ ] Integrate AssemblyAI or Deepgram streaming STT
  - [ ] Stream audio packets to STT provider in real-time
  - [ ] Handle partial transcript fragments from STT
  - [ ] Implement transcript aggregation logic
  - [ ] Handle STT connection errors and retries

- [ ] Task 4: Transcript Storage and Context (AC: 7, 8)
  - [ ] Store complete utterances in Redis session cache
  - [ ] Maintain conversation history in session
  - [ ] Link transcripts to trace IDs for observability
  - [ ] Implement transcript expiration (e.g., 1 hour TTL)

- [ ] Task 5: Error Handling and Fallback (AC: 9)
  - [ ] Detect STT failures
  - [ ] Provide fallback to text input in client
  - [ ] Show user-friendly error messages
  - [ ] Log errors for debugging

---

## Dev Notes

### Previous Story Insights
- Session management is already implemented (Story 1.1)
- Redis connection is available for transcript storage

### Architecture References
[Source: docs/architecture.md#journey-flows]

**Audio Flow:**
```
User Voice â†’ Client Microphone
  â†“
Client Audio Capture (16kHz, mono, PCM)
  â†“
LiveKit SFU (WebRTC)
  â†“
Orchestrator Audio Handler
  â†“
STT Provider (Streaming)
  â†“
Partial Transcripts â†’ Orchestrator
```

**STT Provider Options:**
- AssemblyAI: `assemblyai/universal-streaming:en`
- Deepgram: Streaming API

**Transcript Processing:**
- Partial transcripts aggregated into complete utterances
- Stored in Redis with conversation context
- Linked to trace IDs for observability

### Existing Codebase Context

**Current Implementation:**
- `livekit-voice-agent/agent.py` already has basic AgentSession setup
- Uses `assemblyai/universal-streaming:en` for STT
- `agent-starter-react/hooks/useRoom.ts` handles microphone setup
- `AgentControlBar` has microphone toggle functionality

**Files to Modify:**
- `livekit-voice-agent/agent.py` - Enhance STT handling
- `agent-starter-react/components/livekit/agent-control-bar/agent-control-bar.tsx` - Add audio capture indicator
- `agent-starter-react/hooks/useRoom.ts` - Verify audio settings

**Files to Create:**
- `livekit-voice-agent/stt_handler.py` - STT provider integration
- `livekit-voice-agent/transcript_manager.py` - Transcript storage and aggregation

### File Locations

**Backend (Orchestrator):**
- `livekit-voice-agent/stt_handler.py` - New file for STT integration
- `livekit-voice-agent/transcript_manager.py` - New file for transcript management
- `livekit-voice-agent/agent.py` - Modify to use new STT handler

**Frontend (Web):**
- `agent-starter-react/components/livekit/agent-control-bar/agent-control-bar.tsx` - Add audio indicator
- `agent-starter-react/components/livekit/audio-indicator.tsx` - New component for waveform animation

**Mobile:**
- `agent-starter-react-native/components/AudioIndicator.tsx` - New component for mobile

### Testing Requirements

**Unit Tests:**
- Test transcript aggregation logic
- Test Redis storage and retrieval
- Test STT error handling

**Integration Tests:**
- Test full audio capture â†’ STT â†’ transcript flow
- Test partial transcript handling
- Test conversation context persistence

**E2E Tests:**
- Test voice input end-to-end
- Test fallback to text input on STT failure

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

