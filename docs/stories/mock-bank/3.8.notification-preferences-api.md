# Story 3.8: Notification Preferences API Endpoints

**Status:** Ready for Development  
**Epic:** Epic 5 - Alerts and Notifications Management  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema)

---

## Story

**As a** banking customer  
**I want to** manage my notification preferences  
**So that** I can control how and when I receive notifications about banking events

---

## Acceptance Criteria

1. **API Endpoints**: CRUD endpoints for notification preferences:
   - `GET /api/banking/notifications` - Retrieve all notification preferences
   - `POST /api/banking/notifications` - Create new notification preference
   - `PUT /api/banking/notifications/[id]` - Update existing preference
   - `DELETE /api/banking/notifications/[id]` - Delete preference

2. **GET /api/banking/notifications**:
   - Requires JWT authentication
   - Returns array of notification preference objects for authenticated user
   - Response includes: id, channel, eventType, isEnabled, createdAt, updatedAt

3. **POST /api/banking/notifications**:
   - Request body:
     ```json
     {
       "channel": "email",
       "eventType": "payment",
       "isEnabled": true
     }
     ```
   - Validates channel is one of: "email", "sms", "push"
   - Validates eventType is one of: "payment", "alert", "balance", "transaction"
   - Validates unique constraint: (userId, channel, eventType) combination must be unique
   - Creates preference with provided settings
   - Returns created preference object

4. **PUT /api/banking/notifications/[id]**:
   - Validates preference belongs to user
   - Updates provided fields (channel, eventType, isEnabled)
   - Validates unique constraint if channel/eventType changed
   - Returns updated preference object

5. **DELETE /api/banking/notifications/[id]**:
   - Validates preference belongs to user
   - Deletes preference
   - Returns 204 No Content

6. **Security**: All operations scoped to authenticated user

7. **Error Handling**:
   - Returns 400 for validation errors
   - Returns 401 for authentication errors
   - Returns 404 if preference not found or doesn't belong to user
   - Returns 409 if unique constraint violated
   - Returns 500 for database errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Routes**
  - [ ] Create `app/api/banking/notifications/route.ts` (GET, POST)
  - [ ] Create `app/api/banking/notifications/[id]/route.ts` (PUT, DELETE)
  - [ ] Implement authentication for all endpoints
  - [ ] Implement OPTIONS handlers for CORS

- [ ] **Task 2: Business Logic**
  - [ ] Implement GET handler (list preferences)
  - [ ] Implement POST handler (create preference)
  - [ ] Implement PUT handler (update preference)
  - [ ] Implement DELETE handler (delete preference)

- [ ] **Task 3: Validation**
  - [ ] Validate channel enum values
  - [ ] Validate eventType enum values
  - [ ] Validate unique constraint (userId, channel, eventType)
  - [ ] Validate preference ownership (for update/delete)

- [ ] **Task 4: Testing**
  - [ ] Test GET endpoint
  - [ ] Test POST endpoint with all channel/eventType combinations
  - [ ] Test PUT endpoint
  - [ ] Test DELETE endpoint
  - [ ] Test unique constraint validation
  - [ ] Test validation errors
  - [ ] Test ownership validation

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing API route patterns
- **Location**: `app/api/banking/notifications/route.ts` and `app/api/banking/notifications/[id]/route.ts`
- **Database**: Uses Prisma with NotificationPreference model

### Channel Types
- `email`: Email notifications
- `sms`: SMS/text message notifications
- `push`: Push notification (mobile app)

### Event Types
- `payment`: Payment-related events
- `alert`: Alert-related events
- `balance`: Balance change events
- `transaction`: Transaction events

### Unique Constraint
The combination of (userId, channel, eventType) must be unique. This means a user can have one preference per channel/eventType combination, but can have multiple preferences for different channels or event types.

---

## Definition of Done

- [ ] All CRUD endpoints implemented
- [ ] Validation working correctly
- [ ] Unique constraint enforced
- [ ] User scoping working correctly
- [ ] Error handling implemented
- [ ] Response formats correct

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


