# Story 3.5: Payment Initiation API Endpoint

**Status:** Ready for Development  
**Epic:** Epic 4 - Payment and Transfer Operations  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema), Story 3.1 (Account Details API)

---

## Story

**As a** banking customer  
**I want to** initiate a payment to a beneficiary, external account, or my own account  
**So that** I can transfer money after confirming with OTP

---

## Acceptance Criteria

1. **API Endpoint**: `POST /api/banking/payments/initiate` endpoint implemented
   - Requires JWT authentication with `transact` permission
   - Accepts payment details and creates pending transaction

2. **Request Body** (supports multiple formats):
   ```json
   // Option 1: By beneficiary ID
   {
     "fromAccount": "CHK-12345-001",
     "beneficiaryId": "uuid",
     "amount": 100.00,
     "description": "Payment to Mom"
   }
   
   // Option 2: By beneficiary nickname
   {
     "fromAccount": "CHK-12345-001",
     "beneficiaryNickname": "Mom",
     "amount": 100.00,
     "description": "Payment to Mom"
   }
   
   // Option 3: By payment address
   {
     "fromAccount": "CHK-12345-001",
     "paymentAddress": "martha.doe@upi",
     "amount": 100.00,
     "description": "Payment to Mom"
   }
   
   // Option 4: Internal transfer
   {
     "fromAccount": "CHK-12345-001",
     "toAccount": "SAV-12345-002",
     "amount": 500.00,
     "description": "Transfer to savings"
   }
   ```

3. **Business Logic**:
   - Resolves beneficiary if `beneficiaryId` or `beneficiaryNickname` provided
   - Validates source account belongs to user
   - Validates sufficient balance (checks but doesn't deduct)
   - Determines if internal (toAccount belongs to user) or external transfer
   - Creates transaction with `status: "pending"`
   - Generates 6-digit OTP code
   - Creates `paymentSessionId`: `payment_{transactionId}_{timestamp}`
   - Stores OTP in Redis with 5-minute TTL
   - Sets transaction `expiresAt` to 10 minutes from now

4. **Response Format**: Returns:
   ```json
   {
     "transaction": {
       "id": "uuid",
       "status": "pending",
       "amount": 100.00,
       "fromAccount": "CHK-12345-001",
       "toAccount": "martha.doe@upi",
       "description": "Payment to Mom",
       "expiresAt": "2025-01-XX...",
       "createdAt": "2025-01-XX..."
     },
     "paymentSessionId": "payment_uuid_timestamp",
     "message": "OTP sent to your registered email/phone",
     "otpCode": "123456" // Only in development mode
   }
   ```

5. **Validation**:
   - Amount must be positive
   - Source account must belong to user
   - Source account must have sufficient balance
   - Beneficiary must belong to user (if provided)
   - Payment address must be valid UPI ID or account number format
   - For internal transfers, destination account must belong to user

6. **Error Handling**:
   - Returns 400 for validation errors
   - Returns 401 for authentication errors
   - Returns 404 if beneficiary not found
   - Returns 400 for insufficient funds
   - Returns 500 for database/Redis errors

7. **OTP Storage**: Uses existing `storeOTP` from `@/lib/otp-store`

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Route**
  - [ ] Create `app/api/banking/payments/initiate/route.ts`
  - [ ] Implement POST handler with authentication
  - [ ] Implement OPTIONS handler for CORS

- [ ] **Task 2: Business Logic Layer**
  - [ ] Create `lib/banking/payments.ts` with `initiatePayment` function
  - [ ] Create `lib/banking/beneficiaries.ts` with `resolveBeneficiary` function
  - [ ] Implement beneficiary resolution logic
  - [ ] Implement payment destination resolution (beneficiary, paymentAddress, or toAccount)
  - [ ] Implement internal vs external transfer detection

- [ ] **Task 3: Validation**
  - [ ] Create `lib/banking/validators.ts` with validation functions
  - [ ] Validate amount (positive)
  - [ ] Validate account ownership
  - [ ] Validate balance sufficiency
  - [ ] Validate beneficiary ownership
  - [ ] Validate UPI ID format
  - [ ] Validate account number format

- [ ] **Task 4: OTP Generation**
  - [ ] Create `lib/banking/payment-otp.ts` with OTP utilities
  - [ ] Generate 6-digit OTP
  - [ ] Generate paymentSessionId
  - [ ] Store OTP in Redis using existing `storeOTP` function

- [ ] **Task 5: Transaction Creation**
  - [ ] Create pending transaction in database
  - [ ] Link to beneficiary if applicable
  - [ ] Set expiresAt timestamp
  - [ ] Store paymentSessionId in transaction

- [ ] **Task 6: Testing**
  - [ ] Test with beneficiary ID
  - [ ] Test with beneficiary nickname
  - [ ] Test with payment address
  - [ ] Test internal transfer
  - [ ] Test validation errors
  - [ ] Test insufficient balance
  - [ ] Test OTP generation and storage

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing API route patterns
- **Location**: `app/api/banking/payments/initiate/route.ts`
- **OTP**: Uses existing `@/lib/otp-store` utilities
- **Redis**: Uses existing Redis client for OTP storage

### Beneficiary Resolution Priority
1. `beneficiaryId` (if provided)
2. `beneficiaryNickname` (if provided)
3. `paymentAddress` (if provided)
4. `toAccount` (if provided)

### UPI ID Validation
Pattern: `^[a-zA-Z0-9._-]+@[a-zA-Z0-9]+$`

### Transaction Status
All initiated transactions start with `status: "pending"` and are completed in Story 3.6.

---

## Definition of Done

- [ ] API endpoint implemented
- [ ] All payment destination formats supported
- [ ] Beneficiary resolution working
- [ ] OTP generation and storage working
- [ ] Validation implemented
- [ ] Pending transaction created correctly
- [ ] Error handling implemented

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


