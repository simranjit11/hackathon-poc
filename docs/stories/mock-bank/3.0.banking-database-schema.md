# Story 3.0: Banking Database Schema and Foundation

**Status:** Ready for Development  
**Epic:** Epic 1 - Database Schema and Foundation  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)

---

## Story

**As a** developer  
**I want to** have database schema for banking entities (accounts, loans, transactions, payment reminders)  
**So that** I can implement banking API endpoints with proper data persistence

---

## Acceptance Criteria

1. **Database Models**: Prisma schema includes all banking models:
   - `Account` model with fields: id, userId, accountNumber, accountType, balance, creditLimit, currency, status, timestamps
   - `Loan` model with fields: id, userId, accountId, loanType, loanNumber, outstandingBalance, interestRate, monthlyPayment, remainingTermMonths, nextPaymentDate, timestamps
   - `Transaction` model with fields: id, userId, accountId, transactionType, amount, currency, fromAccount, toAccount, beneficiaryId, description, status, referenceNumber, paymentSessionId, expiresAt, completedAt, createdAt
   - `PaymentReminder` model with fields: id, userId, scheduledDate, amount, recipient, description, beneficiaryId, accountId, isCompleted, reminderNotificationSettings, timestamps

2. **Relationships**: All models have proper foreign key relationships:
   - Account → User (many-to-one)
   - Loan → User and Account (many-to-one, optional account)
   - Transaction → User, Account, and Beneficiary (many-to-one, optional beneficiary)
   - PaymentReminder → User, Account, and Beneficiary (many-to-one, optional beneficiary)
   - Beneficiary → Transaction and PaymentReminder (one-to-many, add to existing Beneficiary model)
   - Account → PaymentReminder (one-to-many)

3. **Indexes**: Appropriate indexes created for:
   - Foreign keys (userId, accountId, beneficiaryId)
   - Frequently queried fields (accountType, status, transactionType, paymentSessionId, scheduledDate, isCompleted)
   - Unique constraints (accountNumber, loanNumber, referenceNumber, paymentSessionId)

4. **User Model Extension**: User model updated with relations to all new models

5. **Migration**: Database migration created and tested successfully

6. **Seed Data**: Seed script includes sample banking data:
   - Sample accounts (checking, savings, credit card) for test users
   - Sample loans for test users
   - Sample transactions for test users
   - Sample payment reminders for test users

---

## Tasks / Subtasks

- [ ] **Task 1: Prisma Schema Updates**
  - [ ] Add `Account` model to `prisma/schema.prisma`
  - [ ] Add `Loan` model to `prisma/schema.prisma`
  - [ ] Add `Transaction` model to `prisma/schema.prisma`
  - [ ] Add `PaymentReminder` model to `prisma/schema.prisma`
  - [ ] Update `User` model with new relations
  - [ ] Update `Beneficiary` model with `transactions` and `paymentReminders` relations
  - [ ] Update `Account` model with `paymentReminders` relation

- [ ] **Task 2: Database Migration**
  - [ ] Run `npx prisma migrate dev --name add_banking_models`
  - [ ] Verify migration SQL is correct
  - [ ] Test migration on clean database

- [ ] **Task 3: Seed Data**
  - [ ] Update `prisma/seed.ts` with banking seed data
  - [ ] Create sample accounts for existing test users
  - [ ] Create sample loans for test users
  - [ ] Create sample transactions (completed and pending)
  - [ ] Create sample payment reminders (completed and pending)
  - [ ] Test seed script execution

- [ ] **Task 4: Verification**
  - [ ] Verify all models generate correctly with Prisma Client
  - [ ] Verify relationships work correctly
  - [ ] Verify indexes are created
  - [ ] Verify seed data loads correctly

---

## Dev Notes

### Architecture Alignment
- **Database**: PostgreSQL via Prisma ORM (existing pattern)
- **Naming Convention**: Snake_case for database columns, camelCase for Prisma fields
- **Data Types**: Use `Decimal` for monetary values to prevent floating-point errors
- **Relations**: Cascade delete for user-related data, SetNull for optional relations

### Technical Implementation

**Key Schema Decisions**:
- Transaction `status` defaults to `"pending"` (for two-step payment flow)
- Transaction includes `paymentSessionId` for OTP linking
- Transaction includes `expiresAt` for pending transaction expiration
- All monetary fields use `Decimal(15, 2)` for precision
- All models include `createdAt` and `updatedAt` timestamps

**Seed Data Requirements**:
- At least 2 accounts per test user (checking, savings)
- At least 1 credit card account per test user
- At least 1 loan per test user
- Mix of completed and pending transactions
- Sample payment reminders (some completed, some scheduled for future)

---

## Definition of Done

- [ ] All Prisma models defined and validated
- [ ] Database migration created and tested
- [ ] Seed data script updated and tested
- [ ] All relationships verified working
- [ ] Indexes created and verified
- [ ] Prisma Client regenerated successfully
- [ ] No linting errors

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |
| 2025-01-XX | 1.1 | Removed PaymentAlert and NotificationPreference, added PaymentReminder | John (PM) |


