# Story 3.1: Account Details API Endpoint

**Status:** Ready for Development  
**Epic:** Epic 2 - Account and Balance Read Operations  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema)

---

## Story

**As a** banking customer  
**I want to** retrieve my account details  
**So that** I can view my account information including account numbers, types, and status

---

## Acceptance Criteria

1. **API Endpoint**: `GET /api/banking/accounts` endpoint implemented
   - Requires JWT authentication via `Authorization: Bearer <token>` header
   - Returns all accounts for authenticated user
   - Returns 401 if authentication fails

2. **Response Format**: Returns array of account objects with:
   - `id`: Account UUID
   - `accountNumber`: Account number (e.g., "CHK-12345-001")
   - `accountType`: Account type ("checking", "savings", "credit_card")
   - `balance`: Current balance (Decimal)
   - `creditLimit`: Credit limit (for credit cards, null otherwise)
   - `currency`: Currency code (default "USD")
   - `status`: Account status ("active", "closed", "frozen")
   - `createdAt`: Account creation timestamp

3. **Security**: 
   - Only returns accounts belonging to authenticated user
   - Uses existing `validateAccessToken` and `extractTokenFromHeader` from `@/lib/auth`
   - Follows existing authentication pattern from `/api/beneficiaries`

4. **CORS Support**: Uses existing `corsResponse` and `corsPreflight` utilities

5. **Error Handling**: 
   - Returns 401 for invalid/missing token
   - Returns 500 for database errors with appropriate error message
   - Follows existing error response pattern

6. **Performance**: Response time < 200ms for typical user with 3-5 accounts

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Route**
  - [ ] Create `app/api/banking/accounts/route.ts`
  - [ ] Implement GET handler with authentication
  - [ ] Implement OPTIONS handler for CORS preflight

- [ ] **Task 2: Business Logic**
  - [ ] Query accounts from database filtered by userId
  - [ ] Format response with required fields
  - [ ] Handle empty account list (return empty array)

- [ ] **Task 3: Error Handling**
  - [ ] Handle authentication errors
  - [ ] Handle database errors
  - [ ] Return appropriate HTTP status codes

- [ ] **Task 4: Testing**
  - [ ] Test with valid authentication token
  - [ ] Test with invalid token
  - [ ] Test with missing token
  - [ ] Test with user having no accounts
  - [ ] Test CORS preflight

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing `/api/beneficiaries` route pattern
- **Authentication**: Reuses `validateAccessToken` from `@/lib/auth`
- **CORS**: Uses `corsResponse` and `corsPreflight` from `@/lib/cors`
- **Database**: Uses Prisma client from `@/lib/db/prisma`

### Implementation Pattern
```typescript
export async function GET(request: NextRequest) {
  if (request.method === 'OPTIONS') {
    return corsPreflight();
  }

  try {
    const authHeader = request.headers.get('Authorization');
    const token = extractTokenFromHeader(authHeader);
    const user = await validateAccessToken(token);

    const accounts = await prisma.account.findMany({
      where: { userId: user.user_id },
      select: { /* fields */ }
    });

    return corsResponse({ data: accounts }, 200);
  } catch (error) {
    // Error handling
  }
}
```

---

## Definition of Done

- [ ] API endpoint implemented and tested
- [ ] Authentication working correctly
- [ ] Returns only user's accounts
- [ ] Error handling implemented
- [ ] CORS support working
- [ ] Response format matches specification
- [ ] Performance meets requirements

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


