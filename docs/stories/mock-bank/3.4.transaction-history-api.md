# Story 3.4: Transaction History API Endpoint

**Status:** Ready for Development  
**Epic:** Epic 3 - Loans and Transactions Read Operations  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema)

---

## Story

**As a** banking customer  
**I want to** retrieve my transaction history with filtering and pagination  
**So that** I can view my past transactions and track my payment activity

---

## Acceptance Criteria

1. **API Endpoint**: `GET /api/banking/transactions` endpoint implemented
   - Requires JWT authentication
   - Supports query parameters for filtering and pagination

2. **Query Parameters**:
   - `accountType` (optional): Filter by account type ("checking", "savings", "credit_card")
   - `beneficiaryId` (optional): Filter transactions to specific beneficiary
   - `transactionType` (optional): Filter by type ("payment", "transfer", "deposit", "withdrawal")
   - `startDate` (optional): ISO 8601 date - filter transactions from this date
   - `endDate` (optional): ISO 8601 date - filter transactions until this date
   - `limit` (optional, default: 10): Number of transactions to return (1-100)
   - `offset` (optional, default: 0): Pagination offset

3. **Response Format**: Returns object with:
   - `data`: Array of transaction objects
   - `meta`: Pagination metadata
     - `total`: Total number of transactions matching filters
     - `limit`: Current limit
     - `offset`: Current offset
     - `hasMore`: Boolean indicating if more results available

4. **Transaction Object** includes:
   - `id`: Transaction UUID
   - `transactionType`: Transaction type
   - `amount`: Transaction amount
   - `currency`: Currency code
   - `fromAccount`: Source account number
   - `toAccount`: Destination account/payment address
   - `beneficiary`: Beneficiary details (if transaction linked to beneficiary)
     - `nickname`: Beneficiary nickname
     - `fullName`: Beneficiary full name
   - `description`: Transaction description
   - `status`: Transaction status ("pending", "completed", "failed", "cancelled")
   - `referenceNumber`: Reference number (if completed)
   - `createdAt`: Transaction creation timestamp
   - `completedAt`: Completion timestamp (if completed)

5. **Filtering Logic**:
   - All filters are AND conditions
   - Date range: startDate <= transaction.createdAt <= endDate
   - Date range cannot exceed 1 year
   - Transactions ordered by createdAt DESC (newest first)

6. **Validation**:
   - `limit` must be between 1 and 100
   - `offset` must be non-negative
   - `startDate` must be before `endDate` if both provided
   - Date range cannot exceed 1 year

7. **Security**: Only returns transactions belonging to authenticated user

8. **Performance**: Response time < 200ms for typical queries

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Route**
  - [ ] Create `app/api/banking/transactions/route.ts`
  - [ ] Implement GET handler with authentication
  - [ ] Implement query parameter parsing

- [ ] **Task 2: Business Logic**
  - [ ] Build Prisma query with filters
  - [ ] Implement pagination
  - [ ] Include beneficiary relation when needed
  - [ ] Calculate total count for pagination metadata

- [ ] **Task 3: Validation**
  - [ ] Validate limit and offset parameters
  - [ ] Validate date range
  - [ ] Validate date range doesn't exceed 1 year

- [ ] **Task 4: Response Formatting**
  - [ ] Format transaction objects
  - [ ] Include beneficiary details when applicable
  - [ ] Calculate pagination metadata

- [ ] **Task 5: Testing**
  - [ ] Test with no filters
  - [ ] Test with each filter individually
  - [ ] Test with multiple filters
  - [ ] Test pagination
  - [ ] Test date range validation
  - [ ] Test with transactions linked to beneficiaries

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing API route patterns
- **Location**: `app/api/banking/transactions/route.ts`
- **Database**: Uses Prisma with Transaction model and includes beneficiary relation

### Query Building
```typescript
const where: any = { userId: user.user_id };

if (accountType) {
  where.account = { accountType };
}

if (beneficiaryId) {
  where.beneficiaryId = beneficiaryId;
}

if (transactionType) {
  where.transactionType = transactionType;
}

if (startDate || endDate) {
  where.createdAt = {};
  if (startDate) where.createdAt.gte = new Date(startDate);
  if (endDate) where.createdAt.lte = new Date(endDate);
}
```

### Pagination
Use Prisma's `skip` and `take` for pagination, and `count()` for total.

---

## Definition of Done

- [ ] API endpoint implemented
- [ ] All filters working correctly
- [ ] Pagination working correctly
- [ ] Validation implemented
- [ ] Beneficiary details included when applicable
- [ ] Performance meets requirements

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


