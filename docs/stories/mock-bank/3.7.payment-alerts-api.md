# Story 3.7: Payment Alerts API Endpoints

**Status:** Ready for Development  
**Epic:** Epic 5 - Alerts and Notifications Management  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema)

---

## Story

**As a** banking customer  
**I want to** manage my payment alerts  
**So that** I can be notified about payment events like low balance or payment received

---

## Acceptance Criteria

1. **API Endpoints**: CRUD endpoints for payment alerts:
   - `GET /api/banking/alerts` - Retrieve all payment alerts
   - `POST /api/banking/alerts` - Create new payment alert
   - `PUT /api/banking/alerts/[id]` - Update existing alert
   - `DELETE /api/banking/alerts/[id]` - Delete alert

2. **GET /api/banking/alerts**:
   - Requires JWT authentication
   - Returns array of alert objects for authenticated user
   - Response includes: id, alertType, threshold, accountId, isActive, createdAt, updatedAt

3. **POST /api/banking/alerts**:
   - Request body:
     ```json
     {
       "alertType": "low_balance",
       "threshold": 100.00,
       "accountId": "uuid" // Optional
     }
     ```
   - Validates alertType is one of: "payment_received", "payment_sent", "low_balance", "high_balance"
   - Validates threshold is positive (required for balance-based alerts)
   - Validates accountId belongs to user (if provided)
   - Creates alert with `isActive: true`
   - Returns created alert object

4. **PUT /api/banking/alerts/[id]**:
   - Validates alert belongs to user
   - Updates provided fields (alertType, threshold, accountId, isActive)
   - Returns updated alert object

5. **DELETE /api/banking/alerts/[id]**:
   - Validates alert belongs to user
   - Deletes alert
   - Returns 204 No Content

6. **Security**: All operations scoped to authenticated user

7. **Error Handling**:
   - Returns 400 for validation errors
   - Returns 401 for authentication errors
   - Returns 404 if alert not found or doesn't belong to user
   - Returns 500 for database errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Routes**
  - [ ] Create `app/api/banking/alerts/route.ts` (GET, POST)
  - [ ] Create `app/api/banking/alerts/[id]/route.ts` (PUT, DELETE)
  - [ ] Implement authentication for all endpoints
  - [ ] Implement OPTIONS handlers for CORS

- [ ] **Task 2: Business Logic**
  - [ ] Implement GET handler (list alerts)
  - [ ] Implement POST handler (create alert)
  - [ ] Implement PUT handler (update alert)
  - [ ] Implement DELETE handler (delete alert)

- [ ] **Task 3: Validation**
  - [ ] Validate alertType enum values
  - [ ] Validate threshold (positive, required for balance alerts)
  - [ ] Validate account ownership (if accountId provided)
  - [ ] Validate alert ownership (for update/delete)

- [ ] **Task 4: Testing**
  - [ ] Test GET endpoint
  - [ ] Test POST endpoint with all alert types
  - [ ] Test PUT endpoint
  - [ ] Test DELETE endpoint
  - [ ] Test validation errors
  - [ ] Test ownership validation

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing API route patterns (similar to `/api/beneficiaries`)
- **Location**: `app/api/banking/alerts/route.ts` and `app/api/banking/alerts/[id]/route.ts`
- **Database**: Uses Prisma with PaymentAlert model

### Alert Types
- `payment_received`: Alert when payment is received
- `payment_sent`: Alert when payment is sent
- `low_balance`: Alert when balance falls below threshold
- `high_balance`: Alert when balance exceeds threshold

### Threshold Validation
- Required for `low_balance` and `high_balance` alert types
- Optional for `payment_received` and `payment_sent` (no threshold needed)

---

## Definition of Done

- [ ] All CRUD endpoints implemented
- [ ] Validation working correctly
- [ ] User scoping working correctly
- [ ] Error handling implemented
- [ ] Response formats correct

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


