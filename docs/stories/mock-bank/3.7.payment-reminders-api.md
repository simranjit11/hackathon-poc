# Story 3.7: Payment Reminders API Endpoints

**Status:** Ready for Development  
**Epic:** Epic 5 - Payment Reminders Management  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.0 (Database Schema)

---

## Story

**As a** banking customer  
**I want to** manage payment reminders for future scheduled payments  
**So that** I can set reminders for upcoming payments and track them

---

## Acceptance Criteria

1. **API Endpoints**: CRUD endpoints for payment reminders:
   - `GET /api/banking/reminders` - Retrieve all payment reminders
   - `POST /api/banking/reminders` - Create new payment reminder
   - `PUT /api/banking/reminders/[id]` - Update existing reminder
   - `DELETE /api/banking/reminders/[id]` - Delete reminder

2. **GET /api/banking/reminders**:
   - Requires JWT authentication
   - Query parameters:
     - `isCompleted` (optional): Filter by completion status (true/false)
     - `scheduledDateFrom` (optional): Filter reminders scheduled from this date (ISO 8601)
     - `scheduledDateTo` (optional): Filter reminders scheduled until this date (ISO 8601)
   - Returns array of payment reminder objects for authenticated user
   - Response includes: id, scheduledDate, amount, recipient, description, beneficiaryId, accountId, isCompleted, reminderNotificationSettings, createdAt, updatedAt
   - Includes beneficiary information if linked (nickname, fullName, paymentAddress)
   - Includes account information (accountNumber, accountType)

3. **POST /api/banking/reminders**:
   - Request body:
     ```json
     {
       "scheduledDate": "2025-02-15T10:00:00Z", // ISO 8601 date
       "amount": 100.00,
       "recipient": "Mom", // Recipient name or payment address
       "description": "Monthly rent payment",
       "beneficiaryId": "uuid", // Optional: link to beneficiary
       "beneficiaryNickname": "Mom", // Optional: alternative to beneficiaryId
       "accountId": "uuid", // Source account for payment
       "reminderNotificationSettings": { // Optional
         "email": true,
         "sms": false,
         "push": true
       }
     }
     ```
   - Validates `scheduledDate` is in the future
   - Validates `amount` is positive
   - Validates `accountId` belongs to authenticated user
   - If `beneficiaryId` or `beneficiaryNickname` provided:
     - Resolves beneficiary (by ID or nickname)
     - Validates beneficiary belongs to authenticated user
     - Links reminder to beneficiary
   - Creates reminder with `isCompleted: false`
   - Returns created reminder object with full details

4. **PUT /api/banking/reminders/[id]**:
   - Validates reminder belongs to user
   - If reminder is already completed, prevents modification of key fields (scheduledDate, amount, recipient, accountId)
   - Allows updating description, reminderNotificationSettings, and marking as completed
   - If updating `scheduledDate`, validates it's still in the future (unless marking as completed)
   - Updates provided fields
   - Returns updated reminder object

5. **DELETE /api/banking/reminders/[id]**:
   - Validates reminder belongs to authenticated user
   - Allows deletion of both completed and pending reminders
   - Returns 204 No Content

6. **Security**: All operations scoped to authenticated user

7. **Error Handling**:
   - Returns 400 for validation errors (past scheduledDate, negative amount, etc.)
   - Returns 401 for authentication errors
   - Returns 404 if reminder not found or doesn't belong to user
   - Returns 409 if trying to modify completed reminder's key fields
   - Returns 500 for database errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create API Routes**
  - [ ] Create `app/api/banking/reminders/route.ts` (GET, POST)
  - [ ] Create `app/api/banking/reminders/[id]/route.ts` (PUT, DELETE)
  - [ ] Implement authentication for all endpoints
  - [ ] Implement OPTIONS handlers for CORS

- [ ] **Task 2: Business Logic**
  - [ ] Implement GET handler (list reminders with filtering)
  - [ ] Implement POST handler (create reminder with beneficiary resolution)
  - [ ] Implement PUT handler (update reminder with completion status handling)
  - [ ] Implement DELETE handler (delete reminder)

- [ ] **Task 3: Validation**
  - [ ] Validate scheduledDate is in the future (for new/updates)
  - [ ] Validate amount is positive
  - [ ] Validate account ownership
  - [ ] Validate beneficiary ownership (if beneficiaryId/nickname provided)
  - [ ] Validate reminderNotificationSettings JSON structure
  - [ ] Validate reminder ownership (for update/delete)
  - [ ] Prevent modification of key fields for completed reminders

- [ ] **Task 4: Beneficiary Integration**
  - [ ] Resolve beneficiary by ID or nickname
  - [ ] Link reminder to beneficiary if provided
  - [ ] Include beneficiary information in responses

- [ ] **Task 5: Testing**
  - [ ] Test GET endpoint with all query parameters
  - [ ] Test POST endpoint with beneficiaryId
  - [ ] Test POST endpoint with beneficiaryNickname
  - [ ] Test POST endpoint without beneficiary
  - [ ] Test PUT endpoint (update pending reminder)
  - [ ] Test PUT endpoint (prevent modification of completed reminder)
  - [ ] Test DELETE endpoint
  - [ ] Test validation errors
  - [ ] Test ownership validation
  - [ ] Test date filtering

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing API route patterns (similar to `/api/beneficiaries`)
- **Location**: `app/api/banking/reminders/route.ts` and `app/api/banking/reminders/[id]/route.ts`
- **Database**: Uses Prisma with PaymentReminder model
- **Business Logic**: `lib/banking/reminders.ts` for reminder operations

### Beneficiary Resolution
- If `beneficiaryId` provided: Direct lookup by ID (must belong to user)
- If `beneficiaryNickname` provided: Lookup by nickname for user
- If both provided: `beneficiaryId` takes precedence
- If neither provided: Reminder created without beneficiary link

### Reminder Notification Settings
- JSON field stored in database
- Structure: `{ email: boolean, sms: boolean, push: boolean }`
- All fields optional
- Used for future notification system integration

### Completion Status
- Reminders start with `isCompleted: false`
- Can be marked as completed via PUT endpoint
- Completed reminders cannot have key fields (scheduledDate, amount, recipient, accountId) modified
- Completed reminders can still be deleted

### Date Filtering
- `scheduledDateFrom`: ISO 8601 date, inclusive
- `scheduledDateTo`: ISO 8601 date, inclusive
- Both optional, can be used together for date range filtering

---

## Definition of Done

- [ ] All CRUD endpoints implemented
- [ ] Filtering by isCompleted and date range working
- [ ] Beneficiary resolution working (by ID and nickname)
- [ ] Validation working correctly
- [ ] User scoping working correctly
- [ ] Completed reminder modification prevention working
- [ ] Error handling implemented
- [ ] Response formats correct
- [ ] Includes beneficiary and account information in responses

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |

