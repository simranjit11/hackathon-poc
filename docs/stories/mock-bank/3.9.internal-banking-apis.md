# Story 3.9: Internal Banking API Endpoints for MCP Server

**Status:** Ready for Development  
**Epic:** Epic 2-4 - Supporting Internal APIs  
**Related Architecture:** [Mock Bank APIs Architecture](../../mock-bank/architecture.md)  
**Dependencies:** Story 3.1 (Account Details), Story 3.4 (Transaction History)

---

## Story

**As a** MCP server developer  
**I want to** access banking data via internal API endpoints  
**So that** the voice assistant can retrieve banking information for users

---

## Acceptance Criteria

1. **API Endpoints**: Internal endpoints for server-to-server communication:
   - `GET /api/internal/banking/accounts/[userId]` - Get accounts for user
   - `GET /api/internal/banking/transactions/[userId]` - Get transactions for user

2. **Authentication**: 
   - Requires `X-API-Key` header with `INTERNAL_API_KEY` value
   - Uses existing `requireApiKey` middleware from `@/lib/api-key-auth`
   - Follows pattern from `/api/internal/users/[id]`

3. **GET /api/internal/banking/accounts/[userId]**:
   - Returns accounts for specified userId
   - Same response format as public `/api/banking/accounts` endpoint
   - Allows MCP server to fetch accounts for any user (server-to-server)

4. **GET /api/internal/banking/transactions/[userId]**:
   - Accepts same query parameters as public endpoint (accountType, beneficiaryId, transactionType, startDate, endDate, limit, offset)
   - Returns transactions for specified userId
   - Same response format as public `/api/banking/transactions` endpoint
   - Allows MCP server to fetch transactions for any user

5. **Security**:
   - Only accessible with valid internal API key
   - Returns 401 if API key missing or invalid
   - Follows existing internal API security pattern

6. **CORS Support**: Uses existing `corsResponse` and `corsPreflight` utilities

7. **Error Handling**:
   - Returns 401 for invalid/missing API key
   - Returns 404 if user not found
   - Returns 400 for invalid query parameters
   - Returns 500 for database errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create Internal API Routes**
  - [ ] Create `app/api/internal/banking/accounts/[userId]/route.ts`
  - [ ] Create `app/api/internal/banking/transactions/[userId]/route.ts`
  - [ ] Implement API key authentication
  - [ ] Implement OPTIONS handlers for CORS

- [ ] **Task 2: Business Logic**
  - [ ] Reuse business logic from public endpoints
  - [ ] Query accounts/transactions by userId (from path parameter)
  - [ ] Support query parameters for transactions endpoint

- [ ] **Task 3: Integration**
  - [ ] Use existing `requireApiKey` middleware
  - [ ] Follow existing internal API pattern
  - [ ] Ensure consistent response formats

- [ ] **Task 4: Testing**
  - [ ] Test with valid API key
  - [ ] Test with invalid API key
  - [ ] Test with missing API key
  - [ ] Test with non-existent userId
  - [ ] Test query parameters for transactions endpoint

---

## Dev Notes

### Architecture Alignment
- **Pattern**: Follows existing `/api/internal/users/[id]` pattern
- **Location**: `app/api/internal/banking/accounts/[userId]/route.ts` and `app/api/internal/banking/transactions/[userId]/route.ts`
- **Authentication**: Uses `requireApiKey` from `@/lib/api-key-auth`

### Use Case
These endpoints allow the MCP server to fetch banking data for users when processing voice assistant requests. The MCP server already has the user's userId from the JWT token, so it can call these endpoints to get banking data.

### Response Format
Should match the public endpoints exactly, so MCP server can use the same response parsing logic.

---

## Definition of Done

- [ ] Internal API endpoints implemented
- [ ] API key authentication working
- [ ] Response formats match public endpoints
- [ ] Query parameters supported for transactions
- [ ] Error handling implemented
- [ ] Follows existing internal API patterns

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | John (PM) |


