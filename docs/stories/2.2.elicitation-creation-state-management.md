# Story 2.2: Elicitation Creation and State Management

**Status:** Ready for Review

---

## Story

**As a** system component  
**I want to** create and manage elicitation state  
**So that** user confirmations can be collected and processed securely

---

## Acceptance Criteria

1. MCP tool can return `create_elicitation` response with structured schema
2. Elicitation schema defines required fields (OTP, confirmation, supervisor approval)
3. Elicitation state is stored in Redis with expiration timeout (5 minutes default)
4. Elicitation is linked to original payment request via trace ID
5. Sequential elicitation queue processes one at a time
6. Elicitation can be cancelled by MCP
7. Expired elicitations are cleaned up automatically

---

## Tasks / Subtasks

- [x] Task 1: Elicitation Schema Definition (AC: 1, 2)
  - [x] Define elicitation request schema (TypeScript/Python)
  - [x] Support elicitation types: otp, confirmation, biometric, form, supervisor_approval
  - [x] Define field schemas with validation rules
  - [x] Include UI hints and platform requirements
  - [x] Include context (masked payment details)

- [x] Task 2: MCP Elicitation Response (AC: 1)
  - [x] Create MCP payment tool that returns elicitation response
  - [x] Generate elicitation_id (UUID v4)
  - [x] Include tool_call_id for linking
  - [x] Return structured elicitation schema

- [x] Task 3: Redis State Management (AC: 3, 4)
  - [x] Create `elicitation_manager.py` module
  - [x] Store elicitation state in Redis
  - [x] Link to tool_call_id and session_id
  - [x] Set expiration timeout (5 minutes)
  - [x] Store elicitation schema and context

- [x] Task 4: Sequential Queue Management (AC: 5)
  - [x] Implement Redis list for elicitation queue
  - [x] Process one elicitation at a time
  - [x] Add to queue when created
  - [x] Remove from queue when completed
  - [x] Handle queue ordering

- [x] Task 5: Elicitation Cancellation (AC: 6)
  - [x] Create `/api/elicitation/{id}/cancel` endpoint (Next.js)
  - [x] Update elicitation status to cancelled
  - [x] Notify client of cancellation
  - [x] Clean up Redis state

- [x] Task 6: Expiration Cleanup (AC: 7)
  - [x] Create background task to check expired elicitations
  - [x] Mark expired elicitations
  - [x] Notify client of expiration
  - [x] Clean up Redis state

---

## Dev Notes

### Previous Story Insights
- Payment request processing exists (Story 2.1)
- Redis session management exists (Story 1.1)

### Architecture References
[Source: docs/architecture.md#elicitation-architecture]

**Elicitation State Machine:**
```
CREATED → PENDING → PROCESSING → COMPLETED
   │         │           │            │
   │         ▼           ▼            │
   │      EXPIRED    FAILED           │
   └─────────┴───────────┴────────────┘
```

**Redis Storage:**
```python
redis.hset(f"elicitation:{elicitation_id}", {
    "tool_call_id": ...,
    "mcp_endpoint": ...,
    "user_id": ...,
    "session_id": ...,
    "status": "pending",
    "schema": ...,
    "context": ...
})
```

**Sequential Queue:**
```python
redis.lpush(f"elicitation_queue:{session_id}", elicitation_id)
current = redis.rpop(f"elicitation_queue:{session_id}")
```

### Existing Codebase Context

**Current Implementation:**
- No elicitation system exists yet
- Need to build from scratch

**Files to Create:**
- `livekit-voice-agent/elicitation_manager.py` - Elicitation state management
- `mcp-server/elicitation.py` - Elicitation endpoints
- `livekit-voice-agent/schemas/elicitation.py` - Elicitation schemas

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |
| 2025-11-20 | 1.1 | Implementation complete - all tasks done | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None - No blocking issues encountered

### Completion Notes List
- Implemented complete elicitation schema system (Python + TypeScript)
- Created Redis-based state management with queue support
- Added MCP tool `make_payment_with_elicitation` for testing
- Created Next.js API endpoints for resume and cancel operations
- Implemented background cleanup task for expired elicitations
- Consolidated all endpoints in Next.js server (no separate FastAPI server needed)
- Created comprehensive testing documentation

### File List

**Created Files:**
- `livekit-voice-agent/schemas/__init__.py` - Schemas package init
- `livekit-voice-agent/schemas/elicitation.py` - Python elicitation schemas and helpers
- `livekit-voice-agent/elicitation_manager.py` - Redis state and queue management
- `livekit-voice-agent/elicitation_cleanup.py` - Background expiration cleanup task
- `mcp-server/tools/payment_elicitation.py` - Mock payment tool with elicitation support
- `agent-starter-react/lib/elicitation-types.ts` - TypeScript type definitions
- `agent-starter-react/app/api/elicitation/resume/route.ts` - Resume payment endpoint
- `agent-starter-react/app/api/elicitation/[id]/cancel/route.ts` - Cancel elicitation endpoint
- `docs/ELICITATION_TESTING.md` - Comprehensive testing procedures

**Modified Files:**
- `mcp-server/main.py` - Added `make_payment_with_elicitation` tool

---

## QA Results
_To be filled by QA Agent_

