# Story 2.2: Elicitation Creation and State Management

**Status:** Draft

---

## Story

**As a** system component  
**I want to** create and manage elicitation state  
**So that** user confirmations can be collected and processed securely

---

## Acceptance Criteria

1. MCP tool can return `create_elicitation` response with structured schema
2. Elicitation schema defines required fields (OTP, confirmation, supervisor approval)
3. Elicitation state is stored in Redis with expiration timeout (5 minutes default)
4. Elicitation is linked to original payment request via trace ID
5. Sequential elicitation queue processes one at a time
6. Elicitation can be cancelled by MCP
7. Expired elicitations are cleaned up automatically

---

## Tasks / Subtasks

- [ ] Task 1: Elicitation Schema Definition (AC: 1, 2)
  - [ ] Define elicitation request schema (TypeScript/Python)
  - [ ] Support elicitation types: otp, confirmation, biometric, form, supervisor_approval
  - [ ] Define field schemas with validation rules
  - [ ] Include UI hints and platform requirements
  - [ ] Include context (masked payment details)

- [ ] Task 2: MCP Elicitation Response (AC: 1)
  - [ ] Modify MCP payment tool to return elicitation response
  - [ ] Generate elicitation_id (UUID v4)
  - [ ] Include tool_call_id for linking
  - [ ] Return structured elicitation schema

- [ ] Task 3: Redis State Management (AC: 3, 4)
  - [ ] Create `elicitation_manager.py` module
  - [ ] Store elicitation state in Redis
  - [ ] Link to tool_call_id and session_id
  - [ ] Set expiration timeout (5 minutes)
  - [ ] Store elicitation schema and context

- [ ] Task 4: Sequential Queue Management (AC: 5)
  - [ ] Implement Redis list for elicitation queue
  - [ ] Process one elicitation at a time
  - [ ] Add to queue when created
  - [ ] Remove from queue when completed
  - [ ] Handle queue ordering

- [ ] Task 5: Elicitation Cancellation (AC: 6)
  - [ ] Create `/mcp/elicitation/{id}/cancel` endpoint
  - [ ] Update elicitation status to cancelled
  - [ ] Notify client of cancellation
  - [ ] Clean up Redis state

- [ ] Task 6: Expiration Cleanup (AC: 7)
  - [ ] Create background task to check expired elicitations
  - [ ] Mark expired elicitations
  - [ ] Notify client of expiration
  - [ ] Clean up Redis state

---

## Dev Notes

### Previous Story Insights
- Payment request processing exists (Story 2.1)
- Redis session management exists (Story 1.1)

### Architecture References
[Source: docs/architecture.md#elicitation-architecture]

**Elicitation State Machine:**
```
CREATED → PENDING → PROCESSING → COMPLETED
   │         │           │            │
   │         ▼           ▼            │
   │      EXPIRED    FAILED           │
   └─────────┴───────────┴────────────┘
```

**Redis Storage:**
```python
redis.hset(f"elicitation:{elicitation_id}", {
    "tool_call_id": ...,
    "mcp_endpoint": ...,
    "user_id": ...,
    "session_id": ...,
    "status": "pending",
    "schema": ...,
    "context": ...
})
```

**Sequential Queue:**
```python
redis.lpush(f"elicitation_queue:{session_id}", elicitation_id)
current = redis.rpop(f"elicitation_queue:{session_id}")
```

### Existing Codebase Context

**Current Implementation:**
- No elicitation system exists yet
- Need to build from scratch

**Files to Create:**
- `livekit-voice-agent/elicitation_manager.py` - Elicitation state management
- `mcp-server/elicitation.py` - Elicitation endpoints
- `livekit-voice-agent/schemas/elicitation.py` - Elicitation schemas

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

