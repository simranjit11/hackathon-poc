# Story 1.1: Pre-LiveKit Authentication Flow

**Status:** Draft

---

## Story

**As a** banking customer  
**I want to** authenticate before connecting to the voice assistant  
**So that** my identity is established securely before any banking operations

---

## Acceptance Criteria

1. User can authenticate via OAuth/OIDC before LiveKit connection
2. Mobile users can authenticate with biometric (Face ID/Touch ID/Fingerprint) during login
3. Web users can authenticate with credentials + optional 2FA
4. Backend API validates access token and extracts user identity
5. LiveKit participant token includes user_id, email, roles, and permissions in custom claims
6. Connection details API returns serverUrl, roomName, and participantToken
7. Client can connect to LiveKit using the provided token
8. Orchestrator extracts user identity from LiveKit token on connection

---

## Tasks / Subtasks

- [ ] Task 1: Enhance Connection Details API with Authentication (AC: 1, 4, 5, 6)
  - [ ] Add authentication middleware to `/api/connection-details` route
  - [ ] Validate access token from Authorization header
  - [ ] Extract user_id, email, roles, permissions from token
  - [ ] Generate LiveKit participant token with custom claims (user_id, email, roles, permissions)
  - [ ] Include session_type: "voice_assistant" in token claims
  - [ ] Set token expiration to 1 hour
  - [ ] Return connection details with participantToken

- [ ] Task 2: Update Client Connection Flow (AC: 7)
  - [ ] Modify `useRoom.ts` hook to include Authorization header in connection details request
  - [ ] Update connection flow to handle authenticated requests
  - [ ] Ensure token is passed correctly to LiveKit connect

- [ ] Task 3: Orchestrator Session Initialization (AC: 8)
  - [ ] Extract user_id from LiveKit room participant metadata
  - [ ] Create Redis session with user_id, email, roles, permissions
  - [ ] Store session_start timestamp and room_name
  - [ ] Set session TTL to 1 hour
  - [ ] Log session creation for audit

- [ ] Task 4: Mobile Biometric Authentication Support (AC: 2)
  - [ ] Research React Native biometric libraries (react-native-biometrics or expo-local-authentication)
  - [ ] Create biometric authentication service
  - [ ] Integrate biometric prompt in mobile login flow
  - [ ] Generate biometric token after successful authentication
  - [ ] Include biometric token in access token claims

- [ ] Task 5: Web 2FA Support (AC: 3)
  - [ ] Add optional 2FA step in web login flow
  - [ ] Support SMS/Email OTP verification
  - [ ] Include 2FA status in access token claims

---

## Dev Notes

### Previous Story Insights
N/A - This is the first story

### Architecture References
[Source: docs/architecture.md#authentication--authorization-architecture]

**Authentication Flow:**
- Pre-LiveKit authentication model
- Mobile: Credentials + Biometric Auth → Auth Service → Access Token + User Identity
- Web: Credentials + Optional 2FA → Auth Service → Access Token + User Identity
- Backend API validates token and generates LiveKit token with user identity in claims

**LiveKit Token Claims:**
```json
{
  "user_id": "12345",
  "email": "user@example.com",
  "roles": ["customer"],
  "permissions": ["read", "transact", "configure"],
  "session_type": "voice_assistant",
  "iat": 1234567890,
  "exp": 1234567890 + 3600
}
```

**Connection Details API:**
- Endpoint: `POST /api/connection-details`
- Request: `Authorization: Bearer <access_token>`
- Response: `{ serverUrl, roomName, participantToken, participantName }`

**Redis Session Structure:**
```python
{
  "user_id": user_id,
  "email": email,
  "roles": roles,
  "permissions": permissions,
  "session_start": timestamp,
  "room_name": room_name,
  "platform": "mobile" | "web"
}
```

### Existing Codebase Context

**Current Implementation:**
- `agent-starter-react/app/api/connection-details/route.ts` exists but doesn't handle authentication
- Currently generates anonymous tokens with random identity
- Uses `livekit-server-sdk` for token generation
- `useRoom.ts` hook handles connection details fetching

**Files to Modify:**
- `agent-starter-react/app/api/connection-details/route.ts` - Add auth validation
- `agent-starter-react/hooks/useRoom.ts` - Add Authorization header
- `livekit-voice-agent/agent.py` - Add session initialization logic

**Files to Create:**
- `livekit-voice-agent/session_manager.py` - Redis session management
- `agent-starter-react/lib/auth.ts` - Client-side auth utilities (if needed)

### File Locations

**Backend (Orchestrator):**
- `livekit-voice-agent/session_manager.py` - New file for Redis session management
- `livekit-voice-agent/agent.py` - Modify entrypoint to initialize session

**Frontend (Web):**
- `agent-starter-react/app/api/connection-details/route.ts` - Add auth validation
- `agent-starter-react/hooks/useRoom.ts` - Add Authorization header support
- `agent-starter-react/lib/auth.ts` - New file for auth utilities

**Mobile:**
- `agent-starter-react-native/hooks/useBiometricAuth.ts` - New file for biometric auth
- `agent-starter-react-native/lib/auth.ts` - New file for auth utilities

### Testing Requirements

**Unit Tests:**
- Test token validation logic
- Test LiveKit token generation with custom claims
- Test Redis session creation and retrieval
- Test session expiration handling

**Integration Tests:**
- Test full authentication flow from client to orchestrator
- Test session persistence across reconnections
- Test token expiration scenarios

**E2E Tests:**
- Test authenticated connection flow
- Test mobile biometric authentication
- Test web 2FA flow

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

---

## QA Results
_To be filled by QA Agent_

