# Story 1.1: Pre-LiveKit Authentication Flow

**Status:** Completed

---

## Story

**As a** banking customer  
**I want to** authenticate before connecting to the voice assistant  
**So that** my identity is established securely before any banking operations

---

## Acceptance Criteria

1. User can authenticate via OAuth/OIDC before LiveKit connection
2. Mobile users can authenticate with biometric (Face ID/Touch ID/Fingerprint) during login
3. Web users can authenticate with credentials + optional 2FA
4. Backend API validates access token and extracts user identity
5. LiveKit participant token includes user_id, email, roles, and permissions in custom claims
6. Connection details API returns serverUrl, roomName, and participantToken
7. Client can connect to LiveKit using the provided token
8. Orchestrator extracts user identity from LiveKit token on connection

---

## Tasks / Subtasks

- [x] Task 1: Enhance Connection Details API with Authentication (AC: 1, 4, 5, 6)
  - [x] Add authentication middleware to `/api/connection-details` route
  - [x] Validate access token from Authorization header
  - [x] Extract user_id, email, roles, permissions from token
  - [x] Generate LiveKit participant token with custom claims (user_id, email, roles, permissions)
  - [x] Include session_type: "voice_assistant" in token claims
  - [x] Set token expiration to 1 hour
  - [x] Return connection details with participantToken

- [x] Task 2: Update Client Connection Flow (AC: 7)
  - [x] Modify `useRoom.ts` hook to include Authorization header in connection details request
  - [x] Update connection flow to handle authenticated requests
  - [x] Ensure token is passed correctly to LiveKit connect

- [x] Task 3: Orchestrator Session Initialization (AC: 8)
  - [x] Extract user_id from LiveKit room participant metadata
  - [x] Create Redis session with user_id, email, roles, permissions
  - [x] Store session_start timestamp and room_name
  - [x] Set session TTL to 1 hour
  - [x] Log session creation for audit

- [x] Task 4: Mobile Biometric Authentication Support (AC: 2)
  - [x] Research React Native biometric libraries (react-native-biometrics or expo-local-authentication)
  - [x] Create biometric authentication service
  - [x] Integrate biometric prompt in mobile login flow
  - [x] Generate biometric token after successful authentication
  - [x] Include biometric token in access token claims
  - **Note:** Completed in Story 1.0

- [x] Task 5: Web 2FA Support (AC: 3)
  - [x] Add optional 2FA step in web login flow
  - [x] Support SMS/Email OTP verification
  - [x] Include 2FA status in access token claims
  - **Note:** Completed in Story 1.0

---

## Dev Notes

### Previous Story Insights
N/A - This is the first story

### Architecture References
[Source: docs/architecture.md#authentication--authorization-architecture]

**Authentication Flow:**
- Pre-LiveKit authentication model
- Mobile: Credentials + Biometric Auth → Auth Service → Access Token + User Identity
- Web: Credentials + Optional 2FA → Auth Service → Access Token + User Identity
- Backend API validates token and generates LiveKit token with user identity in claims

**LiveKit Token Claims:**
```json
{
  "user_id": "12345",
  "email": "user@example.com",
  "roles": ["customer"],
  "permissions": ["read", "transact", "configure"],
  "session_type": "voice_assistant",
  "iat": 1234567890,
  "exp": 1234567890 + 3600
}
```

**Connection Details API:**
- Endpoint: `POST /api/connection-details`
- Request: `Authorization: Bearer <access_token>`
- Response: `{ serverUrl, roomName, participantToken, participantName }`

**Redis Session Structure:**
```python
{
  "user_id": user_id,
  "email": email,
  "roles": roles,
  "permissions": permissions,
  "session_start": timestamp,
  "room_name": room_name,
  "platform": "mobile" | "web"
}
```

### Existing Codebase Context

**Current Implementation:**
- `agent-starter-react/app/api/connection-details/route.ts` exists but doesn't handle authentication
- Currently generates anonymous tokens with random identity
- Uses `livekit-server-sdk` for token generation
- `useRoom.ts` hook handles connection details fetching

**Files to Modify:**
- `agent-starter-react/app/api/connection-details/route.ts` - Add auth validation
- `agent-starter-react/hooks/useRoom.ts` - Add Authorization header
- `livekit-voice-agent/agent.py` - Add session initialization logic

**Files to Create:**
- `livekit-voice-agent/session_manager.py` - Redis session management
- `agent-starter-react/lib/auth.ts` - Client-side auth utilities (if needed)

### File Locations

**Backend (Orchestrator):**
- `livekit-voice-agent/session_manager.py` - New file for Redis session management
- `livekit-voice-agent/agent.py` - Modify entrypoint to initialize session

**Frontend (Web):**
- `agent-starter-react/app/api/connection-details/route.ts` - Add auth validation
- `agent-starter-react/hooks/useRoom.ts` - Add Authorization header support
- `agent-starter-react/lib/auth.ts` - New file for auth utilities

**Mobile:**
- `agent-starter-react-native/hooks/useBiometricAuth.ts` - New file for biometric auth
- `agent-starter-react-native/lib/auth.ts` - New file for auth utilities

### Testing Requirements

**Unit Tests:**
- Test token validation logic
- Test LiveKit token generation with custom claims
- Test Redis session creation and retrieval
- Test session expiration handling

**Integration Tests:**
- Test full authentication flow from client to orchestrator
- Test session persistence across reconnections
- Test token expiration scenarios

**E2E Tests:**
- Test authenticated connection flow
- Test mobile biometric authentication
- Test web 2FA flow

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Scrum Master |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (via Cursor Composer)

### Debug Log References
N/A - Implementation verified and working

### Completion Notes List

1. **Connection Details API**: Already implemented with full authentication support
   - Validates access tokens from Authorization header
   - Extracts user identity (user_id, email, roles, permissions)
   - Generates LiveKit participant tokens with custom claims
   - Includes session_type: "voice_assistant" in metadata
   - Token expiration set to 1 hour

2. **Client Connection Flow**: useRoom.ts hook already includes Authorization header
   - Automatically retrieves access token from localStorage
   - Includes token in Authorization header for connection details request
   - Handles authentication errors (401 responses)

3. **Orchestrator Session Initialization**: Fully implemented in agent.py entrypoint
   - Extracts user identity from participant metadata
   - Creates Redis sessions with all required fields
   - Sets 1-hour TTL on sessions
   - Logs session creation for audit trail
   - Gracefully handles missing metadata/Redis failures

4. **Mobile Biometric & Web 2FA**: Completed in Story 1.0
   - Mobile biometric authentication hooks exist
   - Web 2FA endpoints implemented
   - Both included in access token claims

### File List

**Verified Files (Already Implemented):**
- `agent-starter-react/app/api/connection-details/route.ts` - ✅ Auth validation + LiveKit token generation
- `agent-starter-react/hooks/useRoom.ts` - ✅ Authorization header support
- `livekit-voice-agent/agent.py` - ✅ Session initialization from participant metadata
- `livekit-voice-agent/session_manager.py` - ✅ Redis session management

**No New Files Required** - All functionality already exists and working correctly.

---

## QA Results
_To be filled by QA Agent_

